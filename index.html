<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Journal & Habit Tracker</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìî</text></svg>">
    
    <!-- Dropbox API -->
    <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background-color: #ffffff;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-button:hover {
            background-color: #f8f9fa;
            color: #333;
        }

        .tab-button.active {
            background-color: #3498db;
            color: white;
            border-bottom-color: #2980b9;
        }

        /* Tab Content */
        .tab-content {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 30px;
            min-height: 500px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* Daily Entries Page Styles */
        .daily-entries {
            max-width: 800px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
        }

        .date-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .date-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .journal-textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        .journal-textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        /* Emoji Picker */
        .emoji-section {
            margin-bottom: 20px;
        }

        .recent-emojis {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .emoji-option {
            width: 50px;
            height: 50px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background-color: #fff;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .emoji-option:hover {
            border-color: #3498db;
            transform: scale(1.1);
        }

        .emoji-option.selected {
            border-color: #3498db;
            background-color: #e3f2fd;
            transform: scale(1.1);
        }

        .more-emojis-btn {
            padding: 15px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .more-emojis-btn:hover {
            background-color: #2980b9;
        }

        /* Emoji Modal */
        /* Custom Modal Styles */
        .custom-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .custom-modal-content {
            background-color: white;
            margin: 10% auto;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            animation: slideIn 0.3s ease;
        }

        .custom-modal-header {
            padding: 20px 30px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: none;
        }

        .custom-modal-header h3 {
            margin: 0;
            font-size: 24px;
            color: #2c3e50;
        }

        .custom-modal-body {
            padding: 20px 30px;
            text-align: center;
        }

        .modal-icon {
            font-size: 64px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 80px;
        }

        .modal-icon.success {
            color: #27ae60;
        }

        .modal-icon.error {
            color: #e74c3c;
        }

        .modal-icon.warning {
            color: #f39c12;
        }

        .modal-icon.question {
            color: #3498db;
        }

        .modal-icon.success::before {
            content: "‚úÖ";
        }

        .modal-icon.error::before {
            content: "‚ùå";
        }

        .modal-icon.warning::before {
            content: "‚ö†Ô∏è";
        }

        .modal-icon.question::before {
            content: "‚ùì";
        }

        #modal-message {
            font-size: 16px;
            line-height: 1.5;
            color: #555;
            margin: 0;
        }

        .custom-modal-footer {
            padding: 0 30px 30px;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .modal-btn-primary {
            background-color: #3498db;
            color: white;
        }

        .modal-btn-primary:hover {
            background-color: #2980b9;
        }

        .modal-btn-secondary {
            background-color: #95a5a6;
            color: white;
        }

        .modal-btn-secondary:hover {
            background-color: #7f8c8d;
        }

        .modal-btn-success {
            background-color: #27ae60;
            color: white;
        }

        .modal-btn-success:hover {
            background-color: #219a52;
        }

        .modal-btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .modal-btn-danger:hover {
            background-color: #c0392b;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateY(-30px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .emoji-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .emoji-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .emoji-modal-content {
            background-color: white;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80%;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .emoji-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
            background-color: #f8f9fa;
        }

        .emoji-modal-header h3 {
            margin: 0;
            color: #2c3e50;
        }

        .close-modal {
            font-size: 28px;
            color: #666;
            cursor: pointer;
            border: none;
            background: none;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            background-color: #f0f0f0;
            color: #333;
        }

        .emoji-modal-body {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .emoji-modal .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 10px;
        }

        .emoji-modal .emoji-option {
            width: 45px;
            height: 45px;
            font-size: 22px;
            border: 1px solid transparent;
        }

        .emoji-modal .emoji-option:hover {
            background-color: #f0f0f0;
            border-color: #3498db;
            transform: scale(1.15);
        }

        /* Habit Setup Styles */
        .habit-setup-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .habit-form {
            background-color: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .text-input, .number-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .text-input:focus, .number-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .error-message {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .color-picker-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .color-input {
            width: 60px;
            height: 40px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            padding: 0;
        }

        .color-preview {
            width: 100px;
            height: 40px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background-color: #3498db;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .tracking-values-section {
            margin-top: 10px;
        }

        .tag-input-container {
            position: relative;
        }

        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            min-height: 20px;
        }

        .tag {
            background-color: #3498db;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tag-remove {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }

        .tag-remove:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .tracking-frequency-section {
            margin-top: 10px;
        }

        .frequency-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .tracking-value-dropdown, .frequency-dropdown {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background-color: white;
        }

        .tracking-value-dropdown:disabled {
            background-color: #f5f5f5;
            color: #999;
        }

        .frequency-number {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            width: 100%;
        }

        .remove-frequency-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-frequency-btn:hover {
            background-color: #c0392b;
        }

        .add-frequency-btn {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        .add-frequency-btn:hover {
            background-color: #219a52;
        }

        .add-frequency-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        .saved-habits-section {
            margin-top: 40px;
        }

        .saved-habits-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .habits-list {
            display: grid;
            gap: 15px;
        }

        .habit-card {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #3498db;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: start;
            gap: 20px;
        }

        .habit-info h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 18px;
        }

        .habit-details {
            display: grid;
            gap: 8px;
            font-size: 14px;
            color: #666;
        }

        .habit-detail-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .habit-detail-label {
            font-weight: 600;
            min-width: 120px;
        }

        .habit-tracking-values {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .habit-tracking-value {
            background-color: #ecf0f1;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        .habit-frequency {
            background-color: #e8f4fd;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin: 2px;
        }

        .habit-actions {
            display: flex;
            gap: 10px;
        }

        .edit-btn, .delete-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .edit-btn {
            background-color: #f39c12;
            color: white;
        }

        .edit-btn:hover {
            background-color: #e67e22;
        }

        .delete-btn {
            background-color: #e74c3c;
            color: white;
        }

        .delete-btn:hover {
            background-color: #c0392b;
        }

        .no-habits-message {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 40px;
            background-color: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #bdc3c7;
        }

        /* Daily Habit Tracking Styles */
        .habits-tracking-container {
            display: grid;
            gap: 15px;
            margin-top: 15px;
        }

        .habit-tracking-card {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border-left: 5px solid #3498db;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .habit-tracking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .habit-tracking-name {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }

        .out-of-control-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #666;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background-color: #ddd;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .toggle-switch.active {
            background-color: #e74c3c;
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(26px);
        }

        /* Weekly counters and warnings styling */
        .weekly-counters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 5px;
            font-size: 12px;
        }

        .week-counter {
            background-color: #3498db;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
        }

        .habit-warnings {
            margin: 10px 0;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .warning {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }

        .warning-low {
            background-color: #e8f4f8;
            color: #2980b9;
            border-left: 3px solid #3498db;
        }

        .warning-medium {
            background-color: #fff3cd;
            color: #856404;
            border-left: 3px solid #ffc107;
        }

        .warning-high {
            background-color: #f8d7da;
            color: #721c24;
            border-left: 3px solid #dc3545;
        }

        .warning-critical {
            background-color: #d1ecf1;
            color: #0c5460;
            border-left: 3px solid #17a2b8;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Fine display styling */
        .fine-item {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #e74c3c;
        }

        .fine-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .fine-habit {
            font-weight: 600;
            color: #2c3e50;
        }

        .fine-amount {
            font-size: 18px;
            font-weight: 700;
            color: #e74c3c;
        }

        .fine-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 14px;
            color: #666;
        }

        .fine-status select {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        .warning-item {
            background-color: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .warning-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        .warning-icon {
            font-size: 16px;
        }

        .warning-habit {
            font-weight: 600;
            font-size: 14px;
        }

        .warning-message {
            font-size: 13px;
            color: #555;
            margin-left: 24px;
        }

        .habit-tracking-values {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .tracking-value-option {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background-color: white;
            border: 2px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        .tracking-value-option:hover {
            border-color: #3498db;
            background-color: #ecf0f1;
        }

        .tracking-value-option.selected {
            border-color: #3498db;
            background-color: #3498db;
            color: white;
        }

        .tracking-value-radio {
            margin: 0;
            width: 16px;
            height: 16px;
        }

        .tracking-value-label {
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .no-habits-tracking {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 30px;
            background-color: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #bdc3c7;
        }

        .save-button {
            display: block;
            width: 200px;
            margin: 30px auto;
            padding: 15px 30px;
            background-color: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .save-button:hover {
            background-color: #229954;
        }

        .save-button:active {
            transform: translateY(1px);
        }

        /* Placeholder content for other tabs */
        .placeholder-content {
            text-align: center;
            color: #666;
            font-size: 18px;
            margin-top: 50px;
        }

        /* Recorded Entries Styles */
        .recorded-entries-content {
            padding: 20px;
        }

        /* Fines Styles */
        .fines-content {
            padding: 20px;
        }

        .fines-section {
            margin-bottom: 40px;
        }

        .fines-section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
            font-weight: 600;
        }

        .fine-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #e74c3c;
            transition: all 0.3s ease;
        }

        .fine-card.paid {
            border-left-color: #27ae60;
            background: #f8fff9;
        }

        .fine-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .fine-habit-name {
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        .fine-amount {
            font-size: 1.2em;
            font-weight: 700;
            color: #e74c3c;
        }

        .fine-card.paid .fine-amount {
            color: #27ae60;
        }

        .fine-details {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .fine-status-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .fine-status-dropdown {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .fine-status-dropdown:focus {
            outline: none;
            border-color: #3498db;
        }

        .fine-status-dropdown.paid {
            border-color: #27ae60;
            background-color: #f8fff9;
            color: #27ae60;
            font-weight: 600;
        }

        .warning-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #f39c12;
            transition: all 0.3s ease;
        }

        .warning-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .warning-habit-name {
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        .warning-urgency {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .warning-urgency.high {
            background: #ffeaa7;
            color: #d63031;
        }

        .warning-urgency.medium {
            background: #fab1a0;
            color: #e17055;
        }

        .warning-urgency.low {
            background: #81ecec;
            color: #00b894;
        }

        .warning-message {
            color: #666;
            line-height: 1.4;
        }

        .no-fines-message, .no-warnings-message {
            text-align: center;
            padding: 40px 20px;
            color: #27ae60;
            font-size: 1.1em;
        }

        .no-fines-message p, .no-warnings-message p {
            margin: 0;
        }

        /* Entry actions and delete button styles */
        .entry-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .delete-entry-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .delete-entry-btn:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        /* Yearly Goal Styles */
        .yearly-goal-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 10px;
        }

        .yearly-goal-group {
            margin-bottom: 15px;
        }

        .yearly-goal-group:last-child {
            margin-bottom: 0;
        }

        .contributing-values-container {
            margin-top: 10px;
        }

        .contributing-values-help {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }


        .contributing-value-checkbox {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
            transition: background-color 0.3s ease;
        }

        .contributing-value-checkbox:hover {
            background-color: #f0f8ff;
        }

        .contributing-value-checkbox input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.1);
        }

        .contributing-value-checkbox label {
            margin: 0;
            cursor: pointer;
            flex: 1;
        }

        /* Yearly Analytics Styles */
        .analytics-content {
            padding: 20px;
        }

        .analytics-section {
            margin-bottom: 40px;
        }

        .analytics-section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
            font-weight: 600;
        }

        .year-overview-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .overview-stat {
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            color: #3498db;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 1.1em;
            font-weight: 500;
        }

        .yearly-goals-list, .weekly-streaks-list {
            display: grid;
            gap: 15px;
        }

        .goal-progress-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid;
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .goal-habit-name {
            font-weight: 600;
            font-size: 1.1em;
            color: #333;
        }

        .goal-progress-text {
            font-size: 0.9em;
            color: #666;
        }

        .progress-bar-container {
            background: #f0f0f0;
            border-radius: 20px;
            height: 20px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 100%;
            border-radius: 20px;
            transition: width 0.3s ease;
            background: linear-gradient(45deg, #3498db, #2980b9);
        }

        .goal-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #666;
        }

        .streak-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #27ae60;
        }

        .streak-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .streak-habit-name {
            font-weight: 600;
            font-size: 1.1em;
            color: #333;
        }

        .streak-count {
            font-size: 1.5em;
            font-weight: 700;
            color: #27ae60;
        }

        .streak-message {
            color: #666;
            line-height: 1.4;
        }

        .no-goals-message, .no-streaks-message {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            font-size: 1.1em;
        }

        .no-goals-message p, .no-streaks-message p {
            margin: 0;
        }

        @media (max-width: 768px) {
            .year-overview-card {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .stat-value {
                font-size: 2em;
            }
        }

        .entries-filter {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .filter-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .month-filter {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            background-color: white;
        }

        .filter-btn {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .filter-btn:hover {
            background-color: #2980b9;
        }

        .entries-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .entry-card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            border-left: 5px solid #3498db;
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .entry-date {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .entry-emoji {
            font-size: 24px;
            margin-left: 10px;
        }

        .entry-text {
            font-size: 16px;
            line-height: 1.6;
            color: #333;
            margin-bottom: 15px;
            white-space: pre-wrap;
        }

        .entry-habits {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .entry-habits-title {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            margin-bottom: 10px;
        }

        .entry-habit-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .entry-habit-item:last-child {
            border-bottom: none;
        }

        .entry-habit-name {
            font-weight: 500;
            color: #333;
        }

        .entry-habit-value {
            background-color: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .entry-habit-missed {
            background-color: #e74c3c;
        }

        .no-entries-message {
            text-align: center;
            padding: 50px 20px;
            color: #666;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
                margin-top: 120px; /* Add space for status buttons below title */
            }

            /* Mobile-friendly status buttons */
            #cloud-status {
                position: fixed !important;
                top: 80px !important;
                left: 50% !important;
                transform: translateX(20px) !important;
                font-size: 12px !important;
                padding: 6px 10px !important;
                z-index: 1001 !important;
                max-width: calc(40vw - 15px) !important;
                text-align: center !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            }


            h1 {
                font-size: 2rem;
            }

            .tab-button {
                padding: 12px 10px;
                font-size: 14px;
            }

            .tab-content {
                padding: 20px;
            }

            .recent-emojis {
                gap: 8px;
            }

            .emoji-option {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }

            .more-emojis-btn {
                padding: 12px 16px;
                font-size: 14px;
            }

            .emoji-modal-content {
                width: 95%;
                max-height: 70%;
            }

            .emoji-modal .emoji-grid {
                grid-template-columns: repeat(6, 1fr);
                gap: 8px;
            }

            .emoji-modal .emoji-option {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Daily Journal & Habit Tracker</h1>
        
        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-button active" onclick="openTab(event, 'daily-entries')">Daily Entries</button>
            <button class="tab-button" onclick="openTab(event, 'recorded-entries')">Recorded Entries</button>
            <button class="tab-button" onclick="openTab(event, 'fines')">Fines</button>
            <button class="tab-button" onclick="openTab(event, 'habit-setup')">Habit Setup</button>
            <button class="tab-button" onclick="openTab(event, 'yearly-analytics')">Yearly Analytics</button>
        </div>

        <!-- Sync Buttons Container - Pinned between tabs and content -->
        <div id="sync-buttons-container-fixed" style="text-align: center; padding: 15px 0; background: rgba(255,255,255,0.95); border-bottom: 1px solid #e1e8ed;">
            <div id="manual-sync-btn" style="display: inline-block; padding: 8px 16px; background-color: #3498db; color: white; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer; margin: 0 5px; box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);" onclick="performManualSync()" title="Manually sync all data to Dropbox">üîÑ Sync</div>
            <div id="connection-status-btn" style="display: inline-block; padding: 8px 16px; background-color: #27ae60; color: white; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer; margin: 0 5px; box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);" onclick="disconnectDropbox()" title="Click to disconnect from Dropbox">‚òÅÔ∏è Connected</div>
        </div>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Daily Entries Tab -->
            <div id="daily-entries" class="tab-pane active">
                <div class="daily-entries">
                    <div class="form-group">
                        <label for="entry-date">Date:</label>
                        <input type="date" id="entry-date" class="date-input">
                    </div>

                    <div class="form-group">
                        <label for="journal-entry">Journal Entry:</label>
                        <textarea id="journal-entry" class="journal-textarea" placeholder="Write about your day..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Emoji for the Day:</label>
                        <div class="emoji-section">
                            <div class="recent-emojis" id="recent-emojis-container">
                                <!-- Recent emojis will be dynamically populated here -->
                                <button type="button" class="more-emojis-btn" onclick="openEmojiModal()">More</button>
                            </div>
                        </div>
                    </div>

                    <!-- Habit Tracking Section -->
                    <div class="form-group" id="habit-tracking-section">
                        <label>Today's Habits:</label>
                        <div class="habits-tracking-container" id="habits-tracking-container">
                            <!-- Habits will be dynamically populated here -->
                        </div>
                    </div>

                    <button class="save-button" onclick="saveEntry()">Save Entry</button>
                </div>
            </div>

            <!-- Recorded Entries Tab -->
            <div id="recorded-entries" class="tab-pane">
                <div class="recorded-entries-content">
                    <h2>Recorded Entries</h2>
                    <div class="entries-filter">
                        <div class="filter-controls">
                            <input type="month" id="entries-month-filter" class="month-filter">
                            <button class="filter-btn" onclick="filterEntries()">Filter by Month</button>
                            <button class="filter-btn" onclick="showAllEntries()">Show All</button>
                        </div>
                    </div>
                    <div class="entries-list" id="entries-list">
                        <!-- Entries will be dynamically populated here -->
                    </div>
                </div>
            </div>

            <!-- Fines Tab -->
            <div id="fines" class="tab-pane">
                <div class="fines-content">
                    <h2>Fines</h2>
                    
                    <!-- Committed Fines Section -->
                    <div class="fines-section">
                        <h3>Committed Fines</h3>
                        <div class="committed-fines-list" id="committed-fines-list">
                            <!-- Committed fines will be dynamically populated here -->
                        </div>
                        <div class="no-fines-message" id="no-committed-fines" style="display: none;">
                            <p>üéâ No committed fines! Keep up the great work!</p>
                        </div>
                    </div>
                    
                    <!-- Possible Fines Section -->
                    <div class="fines-section">
                        <h3>Possible Fines (Warnings)</h3>
                        <div class="possible-fines-list" id="possible-fines-list">
                            <!-- Possible fines will be dynamically populated here -->
                        </div>
                        <div class="no-warnings-message" id="no-possible-fines" style="display: none;">
                            <p>‚ú® No upcoming fines! You're on track with all your habits!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Habit Setup Tab -->
            <div id="habit-setup" class="tab-pane">
                <div class="habit-setup-content">
                    <h2>Habit Setup</h2>
                    
                    <form class="habit-form" id="habit-form">
                        <!-- Habit Name -->
                        <div class="form-group">
                            <label for="habit-name">Habit Name:</label>
                            <input type="text" id="habit-name" class="text-input" placeholder="Enter unique habit name" required>
                            <div class="error-message" id="habit-name-error"></div>
                        </div>

                        <!-- Color Picker -->
                        <div class="form-group">
                            <label for="habit-color">Habit Color:</label>
                            <div class="color-picker-container">
                                <input type="color" id="habit-color" class="color-input" value="#3498db">
                                <div class="color-preview" id="color-preview"></div>
                            </div>
                        </div>

                        <!-- Tracking Values -->
                        <div class="form-group">
                            <label>Tracking Values:</label>
                            <div class="tracking-values-section">
                                <div class="tag-input-container">
                                    <input type="text" id="tracking-value-input" class="text-input" placeholder="Enter value (e.g., yes, no, minimal) and press Enter">
                                    <div class="tags-container" id="tracking-values-tags"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Tracking Frequency Section -->
                        <div class="form-group">
                            <label>Tracking Frequency:</label>
                            <div class="tracking-frequency-section" id="tracking-frequency-section">
                                <div class="frequency-row" data-frequency-index="0">
                                    <select class="tracking-value-dropdown" disabled>
                                        <option value="">Select tracking value</option>
                                    </select>
                                    <select class="frequency-dropdown">
                                        <option value="weekly">Weekly</option>
                                        <option value="monthly">Monthly</option>
                                        <option value="yearly">Yearly</option>
                                    </select>
                                    <input type="number" class="frequency-number" placeholder="Number" min="1">
                                    <button type="button" class="remove-frequency-btn" onclick="removeFrequency(0)" style="display: none;">√ó</button>
                                </div>
                            </div>
                            <button type="button" class="add-frequency-btn" id="add-frequency-btn" onclick="addFrequency()">+ Add Another Frequency</button>
                        </div>

                        <!-- Fine Amount -->
                        <div class="form-group">
                            <label for="fine-amount">Fine Amount (‚Çπ):</label>
                            <input type="number" id="fine-amount" class="number-input" placeholder="Enter amount in rupees" min="0" step="0.01">
                        </div>

                        <!-- Out of Control Miss -->
                        <div class="form-group">
                            <label for="out-of-control-miss">Out of Control Miss (per year):</label>
                            <input type="number" id="out-of-control-miss" class="number-input" placeholder="How many times can you skip per year" min="0">
                        </div>

                        <!-- Yearly Goal Section -->
                        <div class="form-group">
                            <label>Yearly Goal Settings:</label>
                            <div class="yearly-goal-section">
                                <div class="yearly-goal-group">
                                    <label for="yearly-goal-amount">Yearly Goal Amount:</label>
                                    <input type="number" id="yearly-goal-amount" class="number-input" placeholder="Total count for the year" min="0">
                                </div>
                                <div class="yearly-goal-group">
                                    <label>Contributing Values:</label>
                                    <div class="contributing-values-container" id="contributing-values-container">
                                        <p class="contributing-values-help">Select which tracking values count towards your yearly goal:</p>
                                        <!-- Contributing values checkboxes will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Save Button -->
                        <button type="submit" class="save-button">Save Habit</button>
                    </form>

                    <!-- Saved Habits List -->
                    <div class="saved-habits-section">
                        <h3>Your Habits</h3>
                        <div class="habits-list" id="habits-list">
                            <p class="no-habits-message" id="no-habits-message">No habits added yet. Create your first habit above!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Yearly Analytics Tab -->
            <div id="yearly-analytics" class="tab-pane">
                <div class="analytics-content">
                    <h2>Yearly Analytics</h2>
                    
                    <!-- Year Overview -->
                    <div class="analytics-section">
                        <h3>Year Overview</h3>
                        <div class="year-overview-card">
                            <div class="overview-stat">
                                <div class="stat-value" id="days-left-value">-</div>
                                <div class="stat-label">Days Left in Year</div>
                            </div>
                            <div class="overview-stat">
                                <div class="stat-value" id="year-progress-value">-</div>
                                <div class="stat-label">Year Progress</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Yearly Goals Progress -->
                    <div class="analytics-section">
                        <h3>Yearly Goals Progress</h3>
                        <div class="yearly-goals-list" id="yearly-goals-list">
                            <!-- Yearly goals will be dynamically populated here -->
                        </div>
                        <div class="no-goals-message" id="no-yearly-goals" style="display: none;">
                            <p>No yearly goals set. Add yearly goals in Habit Setup to track your progress!</p>
                        </div>
                    </div>
                    
                    <!-- Weekly Streaks -->
                    <div class="analytics-section">
                        <h3>Weekly Streaks</h3>
                        <div class="weekly-streaks-list" id="weekly-streaks-list">
                            <!-- Weekly streaks will be dynamically populated here -->
                        </div>
                        <div class="no-streaks-message" id="no-weekly-streaks" style="display: none;">
                            <p>No weekly streaks yet. Keep hitting your weekly goals to build streaks!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Modal System -->
    <div class="custom-modal" id="custom-modal">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h3 id="modal-title">Modal Title</h3>
                <span class="close-modal" onclick="closeCustomModal()">&times;</span>
            </div>
            <div class="custom-modal-body">
                <div class="modal-icon" id="modal-icon"></div>
                <p id="modal-message">Modal message content</p>
            </div>
            <div class="custom-modal-footer">
                <button type="button" class="modal-btn modal-btn-secondary" id="modal-cancel-btn" onclick="closeCustomModal()">Cancel</button>
                <button type="button" class="modal-btn modal-btn-primary" id="modal-confirm-btn" onclick="confirmModalAction()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Duplicate Entry Modal -->
    <div class="custom-modal" id="duplicate-entry-modal">
        <div class="custom-modal-content" style="max-width: 700px;">
            <div class="custom-modal-header">
                <h3>Entry Already Exists</h3>
                <span class="close-modal" onclick="closeDuplicateModal()">&times;</span>
            </div>
            <div class="custom-modal-body">
                <div class="modal-icon warning"></div>
                <p>An entry for this date already exists. Would you like to overwrite it or keep the existing entry?</p>
                
                <div style="display: flex; gap: 20px; margin: 20px 0; text-align: left;">
                    <div style="flex: 1; border: 2px solid #e74c3c; border-radius: 10px; padding: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #e74c3c;">Existing Entry</h4>
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <span id="existing-emoji" style="font-size: 24px; margin-right: 10px;">üòÄ</span>
                            <span id="existing-date" style="font-weight: bold; color: #666;"></span>
                        </div>
                        <div id="existing-text" style="background: #f9f9f9; padding: 10px; border-radius: 5px; max-height: 150px; overflow-y: auto;"></div>
                    </div>
                    
                    <div style="flex: 1; border: 2px solid #27ae60; border-radius: 10px; padding: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #27ae60;">New Entry</h4>
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <span id="new-emoji" style="font-size: 24px; margin-right: 10px;">üòÄ</span>
                            <span id="new-date" style="font-weight: bold; color: #666;"></span>
                        </div>
                        <div id="new-text" style="background: #f9f9f9; padding: 10px; border-radius: 5px; max-height: 150px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
            <div class="custom-modal-footer">
                <button type="button" class="modal-btn modal-btn-secondary" onclick="closeDuplicateModal()">Cancel</button>
                <button type="button" class="modal-btn modal-btn-danger" onclick="keepExistingEntry()">Keep Existing</button>
                <button type="button" class="modal-btn modal-btn-success" onclick="overwriteEntry()">Overwrite</button>
            </div>
        </div>
    </div>

    <!-- Emoji Modal -->
    <div class="emoji-modal" id="emoji-modal">
        <div class="emoji-modal-content">
            <div class="emoji-modal-header">
                <h3>Choose an Emoji</h3>
                <span class="close-modal" onclick="closeEmojiModal()">&times;</span>
            </div>
            <div class="emoji-modal-body">
                <div class="emoji-grid">
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòÄ</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòÅ</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòÇ</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü§£</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòÉ</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòÑ</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòÖ</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòÜ</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòâ</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòä</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòã</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòé</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòç</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü•∞</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòò</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòó</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòô</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòö</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üôÇ</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü§ó</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü§©</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü§î</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü§®</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòê</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòë</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üò∂</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üôÑ</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòè</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üò£</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üò•</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòÆ</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü§ê</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòØ</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üò™</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üò´</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü•±</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üò¥</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòå</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòõ</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòú</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòù</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü§§</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòí</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòì</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòî</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòï</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üôÉ</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü§ë</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üò≤</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üôÅ</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòñ</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòû</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòü</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üò§</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üò¢</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üò≠</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üò¶</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòß</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üò®</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üò©</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü§Ø</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üò¨</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üò∞</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üò±</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü•µ</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü•∂</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üò≥</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü§™</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòµ</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü•¥</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üò∑</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü§í</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü§ï</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü§¢</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü§Æ</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü§ß</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü•≥</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü•∫</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü§†</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü§°</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü§•</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü§´</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü§≠</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üßê</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü§ì</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòá</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü•∏</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üòà</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üëø</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üëπ</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üë∫</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üíÄ</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">‚ò†Ô∏è</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üëª</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üëΩ</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üëæ</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü§ñ</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üéÉ</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üí©</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">‚ù§Ô∏è</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üß°</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üíõ</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üíö</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üíô</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üíú</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üñ§</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü§ç</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">ü§é</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üíî</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">‚ù£Ô∏è</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üíï</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üíû</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üíì</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üíó</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üíñ</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üíò</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üíù</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üíü</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">‚òÆÔ∏è</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">‚úùÔ∏è</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">‚ò™Ô∏è</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üïâÔ∏è</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">‚ò∏Ô∏è</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">‚ú°Ô∏è</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üîØ</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üïé</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">‚òØÔ∏è</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">‚ò¶Ô∏è</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üõê</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">‚≠ê</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üåü</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üí´</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">‚ú®</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üî•</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üí•</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üíØ</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üí¢</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üí®</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üí¶</div>
                    <div class="emoji-option" onclick="selectEmojiFromModal(this)">üí§</div>
                </div>
            </div>
        </div>
    </div>

    <script>



        function updateAuthButton() {
            const authButton = document.getElementById('dropbox-auth-btn');
            const statusText = document.getElementById('connection-status');
            if (authButton && statusText) {
                authButton.textContent = isAuthenticated ? 'Connected ‚úì' : 'Connect to Dropbox';
                authButton.style.backgroundColor = isAuthenticated ? '#27ae60' : '#3498db';
                statusText.textContent = isAuthenticated ? 'Online - data synced to Dropbox' : 'Offline mode - data saved locally';
                statusText.style.color = isAuthenticated ? '#27ae60' : '#666';
            }
        }

        async function handleAuthClick() {
            if (isAuthenticated) {
                // Sign out
                localStorage.removeItem('dropboxAccessToken');
                dbx.setAccessToken('');
                isAuthenticated = false;
                updateAuthButton();
                showCustomModal('Info', 'Disconnected from Dropbox', 'info');
                return;
            }

            try {
                // Start OAuth flow
                const authUrl = dbx.getAuthenticationUrl(window.location.href);
                const popup = window.open(authUrl, 'dropbox-auth', 'width=500,height=600');
                
                // Listen for the popup to close or for the access token
                const checkClosed = setInterval(() => {
                    if (popup.closed) {
                        clearInterval(checkClosed);
                        // Check if authentication was successful
                        const hash = window.location.hash;
                        if (hash && hash.includes('access_token')) {
                            // Handle successful authentication through the new system
                            handleDropboxAuth();
                        }
                    }
                }, 1000);
            } catch (error) {
                showCustomModal('Error', 'Failed to connect to Dropbox: ' + error.message, 'error');
            }
        }








        // Initialize Dropbox when DOM is ready


        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', async function() {
            // NEVER load test data - only use real user data from Dropbox
            // Test data loading removed to prevent data loss
            
            // Set today's date as default
            document.getElementById('entry-date').valueAsDate = new Date();
            
            // Initialize recent emojis
            initializeRecentEmojis();
            
            
            // Initialize Dropbox authentication
            handleDropboxAuth();
        });

        // Tab switching functionality
        function openTab(evt, tabName) {
            var i, tabpanes, tabbuttons;
            
            // Hide all tab panes
            tabpanes = document.getElementsByClassName("tab-pane");
            for (i = 0; i < tabpanes.length; i++) {
                tabpanes[i].classList.remove("active");
            }
            
            // Remove active class from all tab buttons
            tabbuttons = document.getElementsByClassName("tab-button");
            for (i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].classList.remove("active");
            }
            
            // Show the selected tab pane and mark button as active
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");

            // Load content based on tab
            if (tabName === 'recorded-entries') {
                loadRecordedEntries();
            }
            
            if (tabName === 'fines') {
                loadFines();
            }
            
            if (tabName === 'yearly-analytics') {
                loadYearlyAnalytics();
            }
        }

        // Dropbox Integration
        const DROPBOX_APP_KEY = 'lxpor7a9x078wwa';
        let dropboxAccessToken = localStorage.getItem('dropboxAccessToken');
        let isAuthenticated = !!dropboxAccessToken;
        let dbx = null;

        // Initialize Dropbox client if we have a token
        if (isAuthenticated) {
            dbx = new Dropbox.Dropbox({ accessToken: dropboxAccessToken });
        }

        // Authentication functions
        function authenticateDropbox() {
            const authUrl = `https://www.dropbox.com/oauth2/authorize?client_id=${DROPBOX_APP_KEY}&response_type=token&redirect_uri=${encodeURIComponent(window.location.origin + window.location.pathname)}`;
            window.location.href = authUrl;
        }

        function handleDropboxAuth() {
            const hash = window.location.hash;
            if (hash && hash.includes('access_token')) {
                const params = new URLSearchParams(hash.substring(1));
                const accessToken = params.get('access_token');
                
                if (accessToken) {
                    dropboxAccessToken = accessToken;
                    localStorage.setItem('dropboxAccessToken', accessToken);
                    isAuthenticated = true;
                    dbx = new Dropbox.Dropbox({ accessToken: accessToken });
                    
                    // Remove the hash from URL
                    history.replaceState(null, null, window.location.pathname);
                    
                    // Show success message
                    alert('Successfully connected to Dropbox! Your data will now sync to the cloud.');
                    updateAuthStatus();
                }
            }
        }

        function connectToDropbox() {
            const authUrl = `https://www.dropbox.com/oauth2/authorize?client_id=${DROPBOX_APP_KEY}&response_type=token&redirect_uri=${encodeURIComponent(window.location.origin + window.location.pathname)}`;
            window.location.href = authUrl;
        }

        function disconnectDropbox() {
            localStorage.removeItem('dropboxAccessToken');
            dropboxAccessToken = null;
            isAuthenticated = false;
            dbx = null;
            updateAuthStatus();
            alert('Disconnected from Dropbox. Your data will now only be saved locally.');
        }

        function updateAuthStatus() {
            // Status is now handled by the pinned sync buttons container
            // No need for floating status div anymore
            
            if (isAuthenticated) {
                // Add sync button when connected
                createSyncButton();
            } else {
                // Remove sync button when disconnected
                removeSyncButton();
            }
        }

        // Cloud sync functions
        async function syncToCloud(data) {
            if (!isAuthenticated || !dbx) return false;
            
            try {
                const fileContent = JSON.stringify(data, null, 2);
                await dbx.filesUpload({
                    path: '/habit-tracker-data.json',
                    contents: fileContent,
                    mode: 'overwrite',
                    autorename: true
                });
                return true;
            } catch (error) {
                console.error('Error syncing to cloud:', error);
                return false;
            }
        }

        async function loadFromCloud() {
            if (!isAuthenticated || !dbx) return null;
            
            try {
                const response = await dbx.filesDownload({ path: '/habit-tracker-data.json' });
                console.log('Dropbox response:', response);
                
                // Correct way to access file content from Dropbox API
                const fileContent = await response.fileBinary.text();
                console.log('Successfully loaded data from Dropbox');
                return JSON.parse(fileContent);
            } catch (error) {
                if (error.status === 409 || error.error_summary?.includes('not_found')) {
                    // File doesn't exist yet, which is fine for first time users
                    console.log('Dropbox file not found - this is normal for first time users');
                    return null;
                }
                console.error('Error loading from cloud:', error);
                return null;
            }
        }

        // Sync Button Functions
        function createSyncButton() {
            // Don't call removeSyncButton() - just create the connected buttons
            
            const container = document.getElementById('sync-buttons-container-fixed');
            if (!container) return;
            
            // Clear container completely and show it
            container.innerHTML = '';
            container.style.display = 'block';
            
            const syncBtn = document.createElement('div');
            syncBtn.id = 'manual-sync-btn';
            syncBtn.innerHTML = 'üîÑ Sync';
            syncBtn.style.cssText = `
                display: inline-block;
                padding: 8px 16px;
                background-color: #3498db;
                color: white;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
                margin: 0 5px;
            `;
            syncBtn.onclick = performManualSync;
            syncBtn.title = 'Manually sync all data to Dropbox';
            
            const statusBtn = document.createElement('div');
            statusBtn.id = 'connection-status-btn';
            statusBtn.innerHTML = '‚òÅÔ∏è Connected';
            statusBtn.style.cssText = `
                display: inline-block;
                padding: 8px 16px;
                background-color: #27ae60;
                color: white;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);
                margin: 0 5px;
            `;
            statusBtn.onclick = disconnectDropbox;
            statusBtn.title = 'Click to disconnect from Dropbox';
            
            container.appendChild(syncBtn);
            container.appendChild(statusBtn);
        }

        function removeSyncButton() {
            const container = document.getElementById('sync-buttons-container-fixed');
            if (container) {
                // Instead of hiding completely, show "Connect to Dropbox" button
                container.innerHTML = '<div style="display: inline-block; padding: 8px 16px; background-color: #e74c3c; color: white; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer; margin: 0 5px; box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);" onclick="connectToDropbox()" title="Click to connect to Dropbox">‚òÅÔ∏è Connect Dropbox</div>';
                container.style.display = 'block';
            }
        }

        async function performManualSync() {
            const syncBtn = document.getElementById('manual-sync-btn');
            if (!syncBtn) return;
            
            // Show syncing state
            syncBtn.innerHTML = '‚è≥ Syncing...';
            syncBtn.style.backgroundColor = '#f39c12';
            syncBtn.onclick = null; // Disable during sync
            
            try {
                // Collect all local data
                const allData = {
                    journalEntries: JSON.parse(localStorage.getItem('journalEntries') || '{}'),
                    habits: JSON.parse(localStorage.getItem('habits') || '[]'),
                    finesStatus: JSON.parse(localStorage.getItem('finesStatus') || '[]'),
                    dailyHabitTracking: JSON.parse(localStorage.getItem('dailyHabitTracking') || '{}'),
                    lastSync: new Date().toISOString()
                };
                
                // Force sync to cloud
                const syncSuccess = await syncToCloud(allData);
                
                if (syncSuccess) {
                    syncBtn.innerHTML = '‚úÖ Synced!';
                    syncBtn.style.backgroundColor = '#27ae60';
                    showCustomModal('Sync Complete!', 'All your data has been successfully synced to Dropbox! üìä‚òÅÔ∏è', 'success', null, true);
                    
                    // Reset button after 2 seconds
                    setTimeout(() => {
                        syncBtn.innerHTML = 'üîÑ Sync';
                        syncBtn.style.backgroundColor = '#3498db';
                        syncBtn.onclick = performManualSync;
                    }, 2000);
                } else {
                    throw new Error('Sync failed');
                }
            } catch (error) {
                console.error('Manual sync failed:', error);
                syncBtn.innerHTML = '‚ùå Failed';
                syncBtn.style.backgroundColor = '#e74c3c';
                showCustomModal('Sync Failed', 'Failed to sync data to Dropbox. Check your connection and try again.', 'error');
                
                // Reset button after 3 seconds
                setTimeout(() => {
                    syncBtn.innerHTML = 'üîÑ Sync';
                    syncBtn.style.backgroundColor = '#3498db';
                    syncBtn.onclick = performManualSync;
                }, 3000);
            }
        }

        // Live sync functionality - automatically syncs all data changes
        async function triggerLiveSync(changeType = 'data_change', showNotification = false) {
            if (!isAuthenticated || !dbx) return false;
            
            try {
                const allData = {
                    journalEntries: JSON.parse(localStorage.getItem('journalEntries') || '{}'),
                    habits: JSON.parse(localStorage.getItem('habits') || '[]'),
                    finesStatus: JSON.parse(localStorage.getItem('finesStatus') || '[]'),
                    dailyHabitTracking: JSON.parse(localStorage.getItem('dailyHabitTracking') || '{}'),
                    lastSync: new Date().toISOString()
                };
                
                const syncSuccess = await syncToCloud(allData);
                if (syncSuccess) {
                    console.log(`Live sync successful: ${changeType}`);
                    updateSyncIndicator('success');
                    
                    if (showNotification) {
                        showCustomModal('Synced!', `${changeType} synced to Dropbox! ‚òÅÔ∏è`, 'success', null, true);
                    }
                    return true;
                } else {
                    console.warn(`Live sync failed: ${changeType}`);
                    updateSyncIndicator('error');
                    return false;
                }
            } catch (error) {
                console.error('Live sync error:', error);
                updateSyncIndicator('error');
                return false;
            }
        }

        // Update sync indicator to show live sync status
        function updateSyncIndicator(status) {
            const statusDiv = document.getElementById('cloud-status');
            if (!statusDiv || !isAuthenticated) return;
            
            const originalBg = statusDiv.style.backgroundColor;
            
            if (status === 'success') {
                statusDiv.style.backgroundColor = '#27ae60';
                statusDiv.innerHTML = '‚òÅÔ∏è Synced';
                
                // Reset after 2 seconds
                setTimeout(() => {
                    statusDiv.innerHTML = '‚òÅÔ∏è Connected';
                    statusDiv.style.backgroundColor = originalBg;
                }, 2000);
            } else if (status === 'error') {
                statusDiv.style.backgroundColor = '#e74c3c';
                statusDiv.innerHTML = '‚òÅÔ∏è Sync Failed';
                
                // Reset after 3 seconds
                setTimeout(() => {
                    statusDiv.innerHTML = '‚òÅÔ∏è Connected';
                    statusDiv.style.backgroundColor = originalBg;
                }, 3000);
            }
        }

        // Enhanced save functions that include live sync
        async function saveDataWithSync(key, data) {
            // Always save to localStorage as backup
            localStorage.setItem(key, JSON.stringify(data));
            
            // Trigger live sync immediately
            await triggerLiveSync(`${key} saved`);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            handleDropboxAuth();
            // Always show sync button container and determine proper state
            const container = document.getElementById('sync-buttons-container-fixed');
            if (container) {
                container.style.display = 'block';
            }
            updateAuthStatus();
        });

        // Emoji selection functionality
        let selectedEmoji = null;
        let recentEmojis = [];

        // Initialize recent emojis from localStorage or defaults
        function initializeRecentEmojis() {
            try {
                const saved = localStorage.getItem('recentEmojis');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    // Validate that it's an array of strings
                    if (Array.isArray(parsed) && parsed.every(item => typeof item === 'string')) {
                        recentEmojis = parsed;
                    } else {
                        throw new Error('Invalid data format');
                    }
                } else {
                    recentEmojis = ['üòä', 'üòÄ', 'üò¢', 'üò¥', 'ü§î'];
                }
            } catch (error) {
                // Fallback to defaults if localStorage data is corrupted
                recentEmojis = ['üòä', 'üòÄ', 'üò¢', 'üò¥', 'ü§î'];
            }
            renderRecentEmojis();
        }

        function selectEmoji(emojiElement) {
            // Store the selected emoji
            selectedEmoji = emojiElement.textContent || emojiElement.getAttribute('data-emoji');
            
            // Update recent emojis (this will re-render)
            updateRecentEmojis(selectedEmoji);
            
            // Re-apply selection after render
            const recentEmojiOptions = document.querySelectorAll('#recent-emojis-container .emoji-option');
            recentEmojiOptions.forEach(option => {
                if (option.textContent === selectedEmoji || option.getAttribute('data-emoji') === selectedEmoji) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
        }

        function openEmojiModal() {
            document.getElementById('emoji-modal').classList.add('show');
            // Focus trap for accessibility
            document.addEventListener('keydown', handleModalKeydown);
        }

        function closeEmojiModal() {
            document.getElementById('emoji-modal').classList.remove('show');
            document.removeEventListener('keydown', handleModalKeydown);
        }

        function handleModalKeydown(event) {
            if (event.key === 'Escape') {
                closeEmojiModal();
            }
        }

        function selectEmojiFromModal(emojiElement) {
            const emoji = emojiElement.textContent;
            selectedEmoji = emoji;
            
            // Update recent emojis
            updateRecentEmojis(emoji);
            
            // Update the visual selection in recent emojis
            const recentEmojiOptions = document.querySelectorAll('.recent-emojis .emoji-option');
            recentEmojiOptions.forEach(option => option.classList.remove('selected'));
            
            // Find and select the matching emoji in recent section if it exists
            recentEmojiOptions.forEach(option => {
                if (option.textContent === emoji || option.getAttribute('data-emoji') === emoji) {
                    option.classList.add('selected');
                }
            });
            
            // Close modal
            closeEmojiModal();
        }

        function updateRecentEmojis(emoji) {
            // Remove if already exists
            recentEmojis = recentEmojis.filter(e => e !== emoji);
            // Add to beginning
            recentEmojis.unshift(emoji);
            // Keep only 5 most recent
            recentEmojis = recentEmojis.slice(0, 5);
            
            // Save to localStorage
            localStorage.setItem('recentEmojis', JSON.stringify(recentEmojis));
            
            // Re-render the UI
            renderRecentEmojis();
        }

        function renderRecentEmojis() {
            const recentEmojiContainer = document.querySelector('#recent-emojis-container');
            
            // Clear existing emoji options (but keep the More button)
            const existingEmojis = recentEmojiContainer.querySelectorAll('.emoji-option');
            existingEmojis.forEach(emoji => emoji.remove());
            
            // Add recent emojis
            recentEmojis.forEach(emoji => {
                const emojiElement = document.createElement('div');
                emojiElement.className = 'emoji-option';
                emojiElement.textContent = emoji;
                emojiElement.setAttribute('data-emoji', emoji);
                emojiElement.onclick = function() { selectEmoji(this); };
                
                // Insert before the More button
                const moreButton = recentEmojiContainer.querySelector('.more-emojis-btn');
                recentEmojiContainer.insertBefore(emojiElement, moreButton);
            });
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('emoji-modal');
            if (event.target === modal) {
                closeEmojiModal();
            }
        }

        // Save entry functionality with Dropbox cloud sync
        async function saveEntry() {
            const date = document.getElementById('entry-date').value;
            const entry = document.getElementById('journal-entry').value;
            
            if (!date) {
                showCustomModal('Missing Date', 'Please select a date', 'error');
                return;
            }
            
            if (!entry.trim()) {
                showCustomModal('Missing Entry', 'Please write a journal entry', 'error');
                return;
            }
            
            if (!selectedEmoji) {
                showCustomModal('Missing Emoji', 'Please select an emoji for the day', 'error');
                return;
            }
            
            // Check if entry already exists for this date
            const entries = JSON.parse(localStorage.getItem('journalEntries') || '{}');
            const existingEntry = entries[date];
            
            if (existingEntry) {
                // Show duplicate entry modal
                showDuplicateEntryModal(existingEntry, {
                    text: entry,
                    emoji: selectedEmoji,
                    date: date
                });
                return;
            }
            
            // No duplicate, proceed with save
            await performSave(date, entry, selectedEmoji);
        }

        // Function to actually perform the save operation
        async function performSave(date, entry, emoji) {
            // Get habit tracking data for today
            const habitData = getAllDailyHabitData(date);
            
            // Save to localStorage and sync to cloud
            const entries = JSON.parse(localStorage.getItem('journalEntries') || '{}');
            entries[date] = {
                text: entry,
                emoji: emoji,
                habitData: habitData,
                timestamp: new Date().toISOString()
            };
            
            // Use the new cloud sync function
            await saveDataWithSync('journalEntries', entries);
            
            // Show success confirmation modal
            if (isAuthenticated) {
                showCustomModal('Entry Saved!', `Entry saved and synced to cloud for ${date}! ‚òÅÔ∏èüìä`, 'success', null, true);
            } else {
                showCustomModal('Entry Saved!', `Entry saved locally for ${date}! Click the cloud status button to enable cloud sync.`, 'success', null, true);
            }
            
            // Clear the form
            clearEntryForm();
        }

        // Function to clear the entry form
        function clearEntryForm() {
            document.getElementById('journal-entry').value = '';
            selectedEmoji = null;
            const allEmojis = document.querySelectorAll('.emoji-option');
            allEmojis.forEach(emoji => emoji.classList.remove('selected'));
            
            // Clear habit selections
            const habitInputs = document.querySelectorAll('#habits-tracking-container input, #habits-tracking-container select');
            habitInputs.forEach(input => {
                if (input.type === 'checkbox') {
                    input.checked = false;
                } else {
                    input.value = '';
                }
            });
        }

        // Duplicate Entry Modal Functions
        let pendingSaveData = null;

        function showDuplicateEntryModal(existingEntry, newEntry) {
            // Store the pending save data
            pendingSaveData = newEntry;
            
            // Populate the modal with entry data
            document.getElementById('existing-emoji').textContent = existingEntry.emoji || 'üòê';
            document.getElementById('existing-date').textContent = newEntry.date;
            document.getElementById('existing-text').textContent = existingEntry.text || 'No text';
            
            document.getElementById('new-emoji').textContent = newEntry.emoji || 'üòê';
            document.getElementById('new-date').textContent = newEntry.date;
            document.getElementById('new-text').textContent = newEntry.text || 'No text';
            
            // Show the modal
            const modal = document.getElementById('duplicate-entry-modal');
            modal.style.display = 'block';
        }

        function closeDuplicateModal() {
            const modal = document.getElementById('duplicate-entry-modal');
            modal.style.display = 'none';
            pendingSaveData = null;
        }

        function keepExistingEntry() {
            // Just close the modal without saving
            closeDuplicateModal();
            showCustomModal('Entry Kept', 'The existing entry has been kept unchanged.', 'info', null, true);
        }

        async function overwriteEntry() {
            if (!pendingSaveData) return;
            
            // Proceed with the save using the pending data
            await performSave(pendingSaveData.date, pendingSaveData.text, pendingSaveData.emoji);
            closeDuplicateModal();
        }

        // localStorage backup functions
        function saveEntryToLocalStorage(date, entry, emoji, habitData) {
            try {
                const entries = JSON.parse(localStorage.getItem('journalEntries') || '{}');
                entries[date] = {
                    text: entry,
                    emoji: emoji,
                    habitData: habitData,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('journalEntries', JSON.stringify(entries));
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }

        function loadEntryFromLocalStorage(date) {
            try {
                const entries = JSON.parse(localStorage.getItem('journalEntries') || '{}');
                return entries[date] || null;
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                return null;
            }
        }

        // Enhanced entry loading with cloud + localStorage
        async function loadEntry(date) {
            let entry = null;
            
            // FIRST: Try to load from Dropbox (the ONLY authoritative source)
            if (isAuthenticated && dbx) {
                try {
                    const cloudData = await loadFromCloud();
                    if (cloudData && cloudData.journalEntries && cloudData.journalEntries[date]) {
                        entry = cloudData.journalEntries[date];
                        console.log('Loaded entry from Dropbox:', entry);
                        // Update localStorage with fresh data from Dropbox
                        const allEntries = JSON.parse(localStorage.getItem('journalEntries') || '{}');
                        allEntries[date] = entry;
                        localStorage.setItem('journalEntries', JSON.stringify(allEntries));
                    }
                } catch (error) {
                    console.error('Error loading entry from Dropbox:', error);
                    // Continue to localStorage fallback
                }
            }
            
            // FALLBACK: Only use localStorage if Dropbox fails
            // But NEVER overwrite existing localStorage data
            if (!entry) {
                entry = loadEntryFromLocalStorage(date);
                console.log('Using localStorage entry (Dropbox unavailable):', entry);
            }
            
            if (entry) {
                // Populate the form
                document.getElementById('journal-entry').value = entry.text || '';
                selectedEmoji = entry.emoji || null;
                
                // Update emoji selection
                const allEmojis = document.querySelectorAll('.emoji-option');
                allEmojis.forEach(emoji => {
                    if (emoji.textContent === selectedEmoji || emoji.getAttribute('data-emoji') === selectedEmoji) {
                        emoji.classList.add('selected');
                    } else {
                        emoji.classList.remove('selected');
                    }
                });
                
                // Load habit data if exists
                if (entry.habitData) {
                    // Populate habit tracking data
                    loadDailyHabits();
                }
            }
        }

        // Habit Setup Functionality
        let trackingValues = [];
        let frequencyCount = 1;
        let editingHabitId = null;

        // Initialize habit setup when DOM is ready
        document.addEventListener('DOMContentLoaded', async function() {
            initializeHabitSetup();
            await loadDailyHabits();
            
            // Auto-load entry when date changes
            const dateInput = document.getElementById('entry-date');
            if (dateInput) {
                dateInput.addEventListener('change', async function() {
                    await loadEntry(this.value);
                    await loadDailyHabits();
                });
            }
        });

        function initializeHabitSetup() {
            // Color picker preview
            const colorInput = document.getElementById('habit-color');
            const colorPreview = document.getElementById('color-preview');
            
            colorInput.addEventListener('change', function() {
                updateColorPreview(this.value);
            });
            
            // Initialize color preview
            updateColorPreview(colorInput.value);

            // Tracking values input
            const trackingValueInput = document.getElementById('tracking-value-input');
            trackingValueInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addTrackingValue();
                }
            });

            // Habit form submission
            const habitForm = document.getElementById('habit-form');
            habitForm.addEventListener('submit', function(e) {
                e.preventDefault();
                saveHabit();
            });

            // Load and display existing habits
            loadHabits();
        }

        function updateColorPreview(color) {
            const colorPreview = document.getElementById('color-preview');
            colorPreview.style.backgroundColor = color;
            colorPreview.textContent = color.toUpperCase();
        }

        function addTrackingValue() {
            const input = document.getElementById('tracking-value-input');
            const value = input.value.trim();
            
            if (value && !trackingValues.includes(value)) {
                trackingValues.push(value);
                input.value = '';
                renderTrackingValueTags();
                updateTrackingValueDropdowns();
                populateContributingValues();
            }
        }

        function removeTrackingValue(value) {
            trackingValues = trackingValues.filter(v => v !== value);
            renderTrackingValueTags();
            updateTrackingValueDropdowns();
            populateContributingValues();
        }

        function renderTrackingValueTags() {
            const container = document.getElementById('tracking-values-tags');
            container.innerHTML = '';
            
            trackingValues.forEach(value => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `
                    <span>${value}</span>
                    <button type="button" class="tag-remove" onclick="removeTrackingValue('${value}')">√ó</button>
                `;
                container.appendChild(tag);
            });
        }

        function updateTrackingValueDropdowns() {
            const dropdowns = document.querySelectorAll('.tracking-value-dropdown');
            dropdowns.forEach(dropdown => {
                const currentValue = dropdown.value;
                dropdown.innerHTML = '<option value="">Select tracking value</option>';
                
                trackingValues.forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    if (value === currentValue) {
                        option.selected = true;
                    }
                    dropdown.appendChild(option);
                });
                
                dropdown.disabled = trackingValues.length === 0;
            });
        }

        function addFrequency() {
            if (frequencyCount >= 3) return;
            
            frequencyCount++;
            const container = document.getElementById('tracking-frequency-section');
            const newRow = document.createElement('div');
            newRow.className = 'frequency-row';
            newRow.setAttribute('data-frequency-index', frequencyCount - 1);
            
            newRow.innerHTML = `
                <select class="tracking-value-dropdown" ${trackingValues.length === 0 ? 'disabled' : ''}>
                    <option value="">Select tracking value</option>
                    ${trackingValues.map(value => `<option value="${value}">${value}</option>`).join('')}
                </select>
                <select class="frequency-dropdown">
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                    <option value="yearly">Yearly</option>
                </select>
                <input type="number" class="frequency-number" placeholder="Number" min="1">
                <button type="button" class="remove-frequency-btn" onclick="removeFrequency(${frequencyCount - 1})">√ó</button>
            `;
            
            container.appendChild(newRow);
            updateAddFrequencyButton();
            updateRemoveFrequencyButtons();
        }

        function removeFrequency(index) {
            const row = document.querySelector(`[data-frequency-index="${index}"]`);
            if (row) {
                row.remove();
                frequencyCount--;
                updateAddFrequencyButton();
                updateRemoveFrequencyButtons();
                
                // Reindex remaining rows
                const remainingRows = document.querySelectorAll('.frequency-row');
                remainingRows.forEach((row, i) => {
                    row.setAttribute('data-frequency-index', i);
                    const removeBtn = row.querySelector('.remove-frequency-btn');
                    if (removeBtn) {
                        removeBtn.setAttribute('onclick', `removeFrequency(${i})`);
                    }
                });
            }
        }

        function updateAddFrequencyButton() {
            const addBtn = document.getElementById('add-frequency-btn');
            addBtn.disabled = frequencyCount >= 3;
            addBtn.textContent = frequencyCount >= 3 ? 'Maximum 3 frequencies allowed' : '+ Add Another Frequency';
        }

        function updateRemoveFrequencyButtons() {
            const removeButtons = document.querySelectorAll('.remove-frequency-btn');
            removeButtons.forEach(btn => {
                btn.style.display = frequencyCount > 1 ? 'flex' : 'none';
            });
        }

        function validateHabitForm() {
            const habitName = document.getElementById('habit-name').value.trim();
            const errorElement = document.getElementById('habit-name-error');
            
            // Check if habit name is unique
            const existingHabits = getHabitsSync();
            const isDuplicate = existingHabits.some(habit => 
                habit.name.toLowerCase() === habitName.toLowerCase() && 
                (editingHabitId === null || habit.id !== editingHabitId)
            );
            
            if (!habitName) {
                errorElement.textContent = 'Habit name is required';
                errorElement.style.display = 'block';
                return false;
            }
            
            if (isDuplicate) {
                errorElement.textContent = 'Habit name must be unique';
                errorElement.style.display = 'block';
                return false;
            }
            
            if (trackingValues.length === 0) {
                showErrorModal('Missing Tracking Values', 'Please add at least one tracking value before saving the habit.');
                return false;
            }
            
            errorElement.style.display = 'none';
            return true;
        }

        async function saveHabit() {
            if (!validateHabitForm()) return;
            
            const habitData = {
                id: editingHabitId || Date.now().toString(),
                name: document.getElementById('habit-name').value.trim(),
                color: document.getElementById('habit-color').value,
                trackingValues: [...trackingValues],
                frequencies: getFrequencyData(),
                fineAmount: parseFloat(document.getElementById('fine-amount').value) || 0,
                outOfControlMiss: parseInt(document.getElementById('out-of-control-miss').value) || 0,
                yearlyGoal: {
                    amount: parseInt(document.getElementById('yearly-goal-amount').value) || 0,
                    contributingValues: getContributingValues()
                }
            };
            
            let habits = await getHabits();
            
            if (editingHabitId) {
                // Update existing habit
                const index = habits.findIndex(h => h.id === editingHabitId);
                if (index !== -1) {
                    habits[index] = habitData;
                }
                editingHabitId = null;
            } else {
                // Add new habit
                habits.push(habitData);
            }
            
            const cloudSaved = await saveHabits(habits);
            resetHabitForm();
            await loadHabits();
            
            if (cloudSaved) {
                showCustomModal('Success', `Habit "${habitData.name}" saved to cloud! üìä`, 'success');
            } else if (isAuthenticated) {
                showCustomModal('Warning', `Habit "${habitData.name}" saved locally. Cloud sync failed, but data is safe.`, 'warning');
            } else {
                showCustomModal('Success', `Habit "${habitData.name}" saved locally! Connect to Dropbox for cloud sync.`, 'success');
            }
        }

        function getFrequencyData() {
            const frequencies = [];
            const frequencyRows = document.querySelectorAll('.frequency-row');
            
            frequencyRows.forEach(row => {
                const trackingValue = row.querySelector('.tracking-value-dropdown').value;
                const frequency = row.querySelector('.frequency-dropdown').value;
                const number = parseInt(row.querySelector('.frequency-number').value);
                
                if (trackingValue && frequency && number > 0) {
                    frequencies.push({
                        trackingValue,
                        frequency,
                        number
                    });
                }
            });
            
            return frequencies;
        }

        function resetHabitForm() {
            document.getElementById('habit-form').reset();
            document.getElementById('habit-color').value = '#3498db';
            updateColorPreview('#3498db');
            trackingValues = [];
            renderTrackingValueTags();
            updateTrackingValueDropdowns();
            
            // Reset frequency rows to just one
            const container = document.getElementById('tracking-frequency-section');
            const firstRow = container.querySelector('.frequency-row');
            container.innerHTML = '';
            
            // Only append firstRow if it exists
            if (firstRow) {
                container.appendChild(firstRow);
                firstRow.querySelector('.tracking-value-dropdown').value = '';
                firstRow.querySelector('.frequency-dropdown').value = 'weekly';
                firstRow.querySelector('.frequency-number').value = '';
            } else {
                // Create a new first row if none exists
                const newRow = document.createElement('div');
                newRow.className = 'frequency-row';
                newRow.setAttribute('data-frequency-index', '0');
                newRow.innerHTML = `
                    <select class="tracking-value-dropdown" disabled>
                        <option value="">Select tracking value</option>
                    </select>
                    <select class="frequency-dropdown">
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                    <input type="number" class="frequency-number" placeholder="Number" min="1">
                    <button type="button" class="remove-frequency-btn" onclick="removeFrequency(0)" style="display: none;">√ó</button>
                `;
                container.appendChild(newRow);
            }
            
            frequencyCount = 1;
            updateAddFrequencyButton();
            updateRemoveFrequencyButtons();
            
            document.getElementById('habit-name-error').style.display = 'none';
        }

        async function getHabits() {
            let habits = [];
            
            // FIRST: Try to load from Dropbox (the ONLY authoritative source)
            if (isAuthenticated && dbx) {
                try {
                    const cloudData = await loadFromCloud();
                    if (cloudData && cloudData.habits) {
                        habits = cloudData.habits;
                        console.log('Loaded habits from Dropbox:', habits);
                        // Update localStorage with fresh data from Dropbox
                        localStorage.setItem('habits', JSON.stringify(habits));
                        return habits;
                    }
                } catch (error) {
                    console.error('Error loading from Dropbox:', error);
                    // Continue to localStorage fallback
                }
            }
            
            // FALLBACK: Only use localStorage if Dropbox fails
            // But NEVER overwrite existing localStorage data
            try {
                const localHabits = localStorage.getItem('habits');
                habits = localHabits ? JSON.parse(localHabits) : [];
                console.log('Using localStorage habits (Dropbox unavailable):', habits);
            } catch (error) {
                console.error('Error loading habits from localStorage:', error);
                return [];
            }
            
            return habits;
        }

        async function saveHabits(habits) {
            // Use the unified cloud sync function
            await saveDataWithSync('habits', habits);
            
            // Check if sync was successful by trying to sync again
            if (isAuthenticated && dbx) {
                try {
                    const allData = {
                        journalEntries: JSON.parse(localStorage.getItem('journalEntries') || '{}'),
                        habits: habits,
                        finesStatus: JSON.parse(localStorage.getItem('finesStatus') || '[]'),
                        lastSync: new Date().toISOString()
                    };
                    const syncSuccess = await syncToCloud(allData);
                    return syncSuccess;
                } catch (error) {
                    console.error('Error syncing habits to cloud:', error);
                    return false;
                }
            }
            return false;
        }

        async function loadHabits() {
            const habits = await getHabits();
            renderHabitsList(habits);
        }

        function renderHabitsList(habits) {
            const container = document.getElementById('habits-list');
            const noHabitsMessage = document.getElementById('no-habits-message');
            
            if (!container) return;
            
            if (habits.length === 0) {
                if (noHabitsMessage) {
                    noHabitsMessage.style.display = 'block';
                    container.innerHTML = '';
                    container.appendChild(noHabitsMessage);
                } else {
                    container.innerHTML = '<p class="no-habits-message">No habits added yet. Create your first habit above!</p>';
                }
                return;
            }
            
            if (noHabitsMessage) {
                noHabitsMessage.style.display = 'none';
            }
            container.innerHTML = '';
            
            habits.forEach(habit => {
                const habitCard = document.createElement('div');
                habitCard.className = 'habit-card';
                habitCard.style.borderLeftColor = habit.color;
                
                habitCard.innerHTML = `
                    <div class="habit-info">
                        <h4>${habit.name}</h4>
                        <div class="habit-details">
                            <div class="habit-detail-row">
                                <span class="habit-detail-label">Tracking Values:</span>
                                <div class="habit-tracking-values">
                                    ${habit.trackingValues.map(value => `<span class="habit-tracking-value">${value}</span>`).join('')}
                                </div>
                            </div>
                            <div class="habit-detail-row">
                                <span class="habit-detail-label">Frequencies:</span>
                                <div>
                                    ${habit.frequencies.map(freq => `<span class="habit-frequency">${freq.trackingValue}: ${freq.number} ${freq.frequency}</span>`).join('')}
                                </div>
                            </div>
                            <div class="habit-detail-row">
                                <span class="habit-detail-label">Fine Amount:</span>
                                <span>‚Çπ${habit.fineAmount}</span>
                            </div>
                            <div class="habit-detail-row">
                                <span class="habit-detail-label">Out of Control Miss:</span>
                                <span>${habit.outOfControlMiss} times/year</span>
                            </div>
                        </div>
                    </div>
                    <div class="habit-actions">
                        <button class="edit-btn" onclick="editHabit('${habit.id}')">Edit</button>
                        <button class="delete-btn" onclick="deleteHabit('${habit.id}')">Delete</button>
                    </div>
                `;
                
                container.appendChild(habitCard);
            });
        }

        async function editHabit(habitId) {
            const habits = await getHabits();
            const habit = habits.find(h => h.id === habitId);
            if (!habit) return;
            
            editingHabitId = habitId;
            
            // Populate form with habit data
            document.getElementById('habit-name').value = habit.name;
            document.getElementById('habit-color').value = habit.color;
            updateColorPreview(habit.color);
            document.getElementById('fine-amount').value = habit.fineAmount;
            document.getElementById('out-of-control-miss').value = habit.outOfControlMiss;
            
            // Set tracking values
            trackingValues = [...habit.trackingValues];
            
            // Populate yearly goal data
            populateYearlyGoalData(habit);
            renderTrackingValueTags();
            updateTrackingValueDropdowns();
            populateContributingValues();
            
            // Set frequency data
            const container = document.getElementById('tracking-frequency-section');
            container.innerHTML = '';
            
            habit.frequencies.forEach((freq, index) => {
                const row = document.createElement('div');
                row.className = 'frequency-row';
                row.setAttribute('data-frequency-index', index);
                
                row.innerHTML = `
                    <select class="tracking-value-dropdown">
                        <option value="">Select tracking value</option>
                        ${habit.trackingValues.map(value => 
                            `<option value="${value}" ${value === freq.trackingValue ? 'selected' : ''}>${value}</option>`
                        ).join('')}
                    </select>
                    <select class="frequency-dropdown">
                        <option value="weekly" ${freq.frequency === 'weekly' ? 'selected' : ''}>Weekly</option>
                        <option value="monthly" ${freq.frequency === 'monthly' ? 'selected' : ''}>Monthly</option>
                        <option value="yearly" ${freq.frequency === 'yearly' ? 'selected' : ''}>Yearly</option>
                    </select>
                    <input type="number" class="frequency-number" placeholder="Number" min="1" value="${freq.number}">
                    <button type="button" class="remove-frequency-btn" onclick="removeFrequency(${index})" ${habit.frequencies.length === 1 ? 'style="display: none;"' : ''}>√ó</button>
                `;
                
                container.appendChild(row);
            });
            
            frequencyCount = habit.frequencies.length;
            updateAddFrequencyButton();
            updateRemoveFrequencyButtons();
            
            // Scroll to form
            document.getElementById('habit-form').scrollIntoView({ behavior: 'smooth' });
        }

        async function deleteHabit(habitId) {
            const habits = await getHabits();
            const habit = habits.find(h => h.id === habitId);
            if (!habit) return;
            
            showConfirmModal(
                'Delete Habit', 
                `Are you sure you want to delete the habit "${habit.name}"? This action cannot be undone.`,
                async function() {
                    const updatedHabits = habits.filter(h => h.id !== habitId);
                    await saveHabits(updatedHabits);
                    await loadHabits();
                    showCustomModal('Success', `Habit "${habit.name}" has been deleted.`, 'success');
                },
                'Delete',
                'Cancel'
            );
        }

        // Custom Modal System
        let modalConfirmCallback = null;

        function showSuccessModal(title, message, buttonText = 'OK') {
            const modal = document.getElementById('custom-modal');
            const titleElement = document.getElementById('modal-title');
            const iconElement = document.getElementById('modal-icon');
            const messageElement = document.getElementById('modal-message');
            const cancelBtn = document.getElementById('modal-cancel-btn');
            const confirmBtn = document.getElementById('modal-confirm-btn');

            titleElement.textContent = title;
            messageElement.textContent = message;
            iconElement.className = 'modal-icon success';
            
            // Hide cancel button for success modals
            cancelBtn.style.display = 'none';
            confirmBtn.textContent = buttonText;
            confirmBtn.className = 'modal-btn modal-btn-success';
            
            modalConfirmCallback = null;
            modal.style.display = 'block';
        }

        function showErrorModal(title, message, buttonText = 'OK') {
            const modal = document.getElementById('custom-modal');
            const titleElement = document.getElementById('modal-title');
            const iconElement = document.getElementById('modal-icon');
            const messageElement = document.getElementById('modal-message');
            const cancelBtn = document.getElementById('modal-cancel-btn');
            const confirmBtn = document.getElementById('modal-confirm-btn');

            titleElement.textContent = title;
            messageElement.textContent = message;
            iconElement.className = 'modal-icon error';
            
            // Hide cancel button for error modals
            cancelBtn.style.display = 'none';
            confirmBtn.textContent = buttonText;
            confirmBtn.className = 'modal-btn modal-btn-danger';
            
            modalConfirmCallback = null;
            modal.style.display = 'block';
        }

        function showConfirmModal(title, message, onConfirm, confirmText = 'Yes', cancelText = 'Cancel') {
            const modal = document.getElementById('custom-modal');
            const titleElement = document.getElementById('modal-title');
            const iconElement = document.getElementById('modal-icon');
            const messageElement = document.getElementById('modal-message');
            const cancelBtn = document.getElementById('modal-cancel-btn');
            const confirmBtn = document.getElementById('modal-confirm-btn');

            titleElement.textContent = title;
            messageElement.textContent = message;
            iconElement.className = 'modal-icon question';
            
            // Show both buttons for confirmation modals
            cancelBtn.style.display = 'inline-block';
            cancelBtn.textContent = cancelText;
            confirmBtn.textContent = confirmText;
            confirmBtn.className = 'modal-btn modal-btn-danger';
            
            modalConfirmCallback = onConfirm;
            modal.style.display = 'block';
        }

        function showCustomModal(title, message, type = 'info') {
            const modal = document.getElementById('custom-modal');
            const titleElement = document.getElementById('modal-title');
            const messageElement = document.getElementById('modal-message');
            const iconElement = document.getElementById('modal-icon');
            const cancelBtn = document.getElementById('modal-cancel-btn');
            const confirmBtn = document.getElementById('modal-confirm-btn');
            
            titleElement.textContent = title;
            messageElement.textContent = message;
            
            // Set icon based on type
            const icons = {
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è'
            };
            iconElement.textContent = icons[type] || icons['info'];
            
            // Hide both buttons for simple notifications
            cancelBtn.style.display = 'none';
            confirmBtn.style.display = 'none';
            
            modal.style.display = 'block';
            
            // Auto-close after 3 seconds for success/info messages
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    closeCustomModal();
                }, 3000);
            }
        }
        
        function closeCustomModal() {
            const modal = document.getElementById('custom-modal');
            modal.style.display = 'none';
            modalConfirmCallback = null;
        }

        function confirmModalAction() {
            if (modalConfirmCallback) {
                modalConfirmCallback();
            }
            closeCustomModal();
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('custom-modal');
            const duplicateModal = document.getElementById('duplicate-entry-modal');
            
            if (event.target === modal) {
                closeCustomModal();
            }
            if (event.target === duplicateModal) {
                closeDuplicateModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('custom-modal');
                const duplicateModal = document.getElementById('duplicate-entry-modal');
                
                if (modal.style.display === 'block') {
                    closeCustomModal();
                }
                if (duplicateModal.style.display === 'block') {
                    closeDuplicateModal();
                }
            }
        });

        // Daily Habit Tracking Functionality
        async function loadDailyHabits() {
            const habits = await getHabits();
            renderDailyHabits(habits);
        }

        function renderDailyHabits(habits) {
            const container = document.getElementById('habits-tracking-container');
            if (!container) return;

            if (habits.length === 0) {
                container.innerHTML = '<div class="no-habits-tracking">No habits configured yet. <a href="#" onclick="openTab(event, \'habit-setup\')">Set up your first habit</a> to start tracking!</div>';
                return;
            }

            container.innerHTML = '';
            const today = getCurrentDate();

            habits.forEach(habit => {
                const habitCard = document.createElement('div');
                habitCard.className = 'habit-tracking-card';
                habitCard.style.borderLeftColor = habit.color;

                // Get existing tracking data for today
                const existingData = getDailyHabitData(today, habit.id);

                // Get live counters and warnings
                const weekCounts = computeWeekCounts(habit.id);
                const warnings = calculateWarnings(habit.id);
                
                // Generate weekly counter display
                const countersHtml = Object.entries(weekCounts)
                    .filter(([key, count]) => count > 0)
                    .map(([key, count]) => `<span class="week-counter">${key}: ${count}</span>`)
                    .join(' ');
                
                // Generate warnings display
                const warningsHtml = warnings.length > 0 ? 
                    `<div class="habit-warnings">
                        ${warnings.map(w => `<span class="warning warning-${w.urgency}">${w.message}</span>`).join('')}
                    </div>` : '';

                habitCard.innerHTML = `
                    <div class="habit-tracking-header">
                        <h4 class="habit-tracking-name">
                            ${habit.name}
                            ${countersHtml ? `<div class="weekly-counters">${countersHtml}</div>` : ''}
                        </h4>
                        <div class="out-of-control-toggle">
                            <span>Out of Control Miss</span>
                            <div class="toggle-switch ${existingData.outOfControlMiss ? 'active' : ''}" 
                                 onclick="toggleOutOfControl('${habit.id}')">
                                <div class="toggle-slider"></div>
                            </div>
                        </div>
                    </div>
                    ${warningsHtml}
                    <div class="habit-tracking-values">
                        ${habit.trackingValues.map(value => `
                            <div class="tracking-value-option ${existingData.selectedValue === value ? 'selected' : ''}" 
                                 onclick="selectTrackingValue('${habit.id}', '${value}')">
                                <span class="tracking-value-label">${value}</span>
                            </div>
                        `).join('')}
                    </div>
                `;

                container.appendChild(habitCard);
            });
        }

        async function selectTrackingValue(habitId, value) {
            const today = getCurrentDate();
            
            // Update UI
            const habitCard = document.querySelector(`[onclick*="${habitId}"]`).closest('.habit-tracking-card');
            const options = habitCard.querySelectorAll('.tracking-value-option');
            options.forEach(option => option.classList.remove('selected'));
            
            // Find and select the clicked option
            options.forEach(option => {
                if (option.textContent.trim() === value) {
                    option.classList.add('selected');
                }
            });

            // Save data
            await saveDailyHabitData(today, habitId, value, null);
            
            // Update live counters and warnings for this habit
            updateHabitCountersAndWarnings(habitId);
        }

        async function toggleOutOfControl(habitId) {
            const today = getCurrentDate();
            const existingData = getDailyHabitData(today, habitId);
            const newOutOfControlState = !existingData.outOfControlMiss;

            // Update UI
            const toggle = document.querySelector(`[onclick*="toggleOutOfControl('${habitId}')"]`);
            if (newOutOfControlState) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }

            // Save data
            await saveDailyHabitData(today, habitId, existingData.selectedValue, newOutOfControlState);
            
            // Update live counters and warnings for this habit
            updateHabitCountersAndWarnings(habitId);
        }

        function getCurrentDate() {
            const dateInput = document.getElementById('entry-date');
            return dateInput.value || new Date().toISOString().split('T')[0];
        }

        function getDailyHabitData(date, habitId) {
            try {
                const data = localStorage.getItem('dailyHabitTracking');
                const allData = data ? JSON.parse(data) : {};
                const dateData = allData[date] || {};
                return dateData[habitId] || { selectedValue: null, outOfControlMiss: false };
            } catch (error) {
                return { selectedValue: null, outOfControlMiss: false };
            }
        }

        async function saveDailyHabitData(date, habitId, selectedValue, outOfControlMiss) {
            try {
                const data = localStorage.getItem('dailyHabitTracking');
                const allData = data ? JSON.parse(data) : {};
                
                if (!allData[date]) {
                    allData[date] = {};
                }
                
                if (!allData[date][habitId]) {
                    allData[date][habitId] = {};
                }

                // Update only the values that are provided
                if (selectedValue !== null) {
                    allData[date][habitId].selectedValue = selectedValue;
                }
                if (outOfControlMiss !== null) {
                    allData[date][habitId].outOfControlMiss = outOfControlMiss;
                }

                localStorage.setItem('dailyHabitTracking', JSON.stringify(allData));
                
                // Trigger live sync for daily habit tracking
                await triggerLiveSync('Daily habit tracking updated');
            } catch (error) {
                console.error('Error saving daily habit data:', error);
            }
        }

        function getAllDailyHabitData(date) {
            try {
                const data = localStorage.getItem('dailyHabitTracking');
                const allData = data ? JSON.parse(data) : {};
                return allData[date] || {};
            } catch (error) {
                return {};
            }
        }
        
        // Get all habit tracking data (for period calculations)
        function getAllHabitTrackingData() {
            try {
                const data = localStorage.getItem('dailyHabitTracking');
                return data ? JSON.parse(data) : {};
            } catch (error) {
                console.error('Error loading all habit tracking data:', error);
                return {};
            }
        }

        // Update habits when date changes
        document.addEventListener('DOMContentLoaded', function() {
            const dateInput = document.getElementById('entry-date');
            if (dateInput) {
                dateInput.addEventListener('change', function() {
                    loadDailyHabits();
                });
            }
        });

        // Recorded Entries Functionality
        async function loadRecordedEntries() {
            await showAllEntries();
        }

        async function showAllEntries() {
            const entriesList = document.getElementById('entries-list');
            if (!entriesList) return;

            const entries = await getAllEntries();
            renderEntries(entries);
        }

        function filterEntries() {
            const monthFilter = document.getElementById('entries-month-filter');
            const selectedMonth = monthFilter.value;
            
            if (!selectedMonth) {
                showCustomModal('Info', 'Please select a month to filter.', 'info');
                return;
            }

            const entries = getAllEntries();
            const filteredEntries = entries.filter(entry => {
                return entry.date.startsWith(selectedMonth);
            });

            renderEntries(filteredEntries);
        }

        async function getAllEntries() {
            let entries = [];
            
            // FIRST: Try to load from Dropbox (the ONLY authoritative source)
            if (isAuthenticated && dbx) {
                try {
                    const cloudData = await loadFromCloud();
                    if (cloudData && cloudData.journalEntries) {
                        console.log('Loaded all entries from Dropbox:', cloudData.journalEntries);
                        for (const [date, entry] of Object.entries(cloudData.journalEntries)) {
                            entries.push({
                                date: date,
                                text: entry.text || '',
                                emoji: entry.emoji || '',
                                habitData: entry.habitData || {},
                                timestamp: entry.timestamp || null
                            });
                        }
                        // Update localStorage with fresh data from Dropbox
                        localStorage.setItem('journalEntries', JSON.stringify(cloudData.journalEntries));
                        
                        // Sort entries by date (newest first) and return early
                        entries.sort((a, b) => new Date(b.date) - new Date(a.date));
                        return entries;
                    }
                } catch (error) {
                    console.error('Error loading all entries from Dropbox:', error);
                    // Continue to localStorage fallback
                }
            }
            
            // FALLBACK: Only use localStorage if Dropbox fails
            // But NEVER overwrite existing localStorage data
            try {
                const journalEntries = JSON.parse(localStorage.getItem('journalEntries') || '{}');
                console.log('Using localStorage entries (Dropbox unavailable):', journalEntries);
                for (const [date, entry] of Object.entries(journalEntries)) {
                    entries.push({
                        date: date,
                        text: entry.text || '',
                        emoji: entry.emoji || '',
                        habitData: entry.habitData || {},
                        timestamp: entry.timestamp || null
                    });
                }
            } catch (error) {
                console.error('Error loading journal entries from localStorage:', error);
            }

            // Sort entries by date (newest first)
            entries.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            return entries;
        }

        function renderEntries(entries) {
            const entriesList = document.getElementById('entries-list');
            if (!entriesList) return;

            if (entries.length === 0) {
                entriesList.innerHTML = `
                    <div class="no-entries-message">
                        <h3>No entries found</h3>
                        <p>Start journaling to see your entries here!</p>
                    </div>
                `;
                return;
            }

            entriesList.innerHTML = '';

            entries.forEach(entry => {
                const entryCard = document.createElement('div');
                entryCard.className = 'entry-card';

                const formattedDate = formatDateForDisplay(entry.date);
                const hasHabits = entry.habitData && Object.keys(entry.habitData).length > 0;

                entryCard.innerHTML = `
                    <div class="entry-header">
                        <div class="entry-date">${formattedDate}</div>
                        <div class="entry-actions">
                            ${entry.emoji ? `<div class="entry-emoji">${entry.emoji}</div>` : ''}
                            <button class="delete-entry-btn" onclick="deleteEntry('${entry.date}')" title="Delete this entry">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="entry-text">${entry.text || 'No journal text'}</div>
                    ${hasHabits ? renderEntryHabits(entry.habitData, entry.date) : ''}
                `;

                entriesList.appendChild(entryCard);
            });
        }

        function renderEntryHabits(habitData, date) {
            if (!habitData || Object.keys(habitData).length === 0) {
                return '';
            }

            let habitsHtml = `
                <div class="entry-habits">
                    <div class="entry-habits-title">Habits Tracked:</div>
            `;

            // Get current habits to match IDs with names
            const currentHabits = getHabitsSync();

            for (const [habitId, data] of Object.entries(habitData)) {
                const habit = currentHabits.find(h => h.id === habitId);
                const habitName = habit ? habit.name : `Habit ${habitId}`;
                const selectedValue = data.selectedValue;
                const outOfControl = data.outOfControlMiss;

                if (selectedValue || outOfControl) {
                    habitsHtml += `
                        <div class="entry-habit-item">
                            <span class="entry-habit-name">${habitName}</span>
                            <div>
                                ${selectedValue ? `<span class="entry-habit-value">${selectedValue}</span>` : ''}
                                ${outOfControl ? `<span class="entry-habit-value entry-habit-missed">Out of Control</span>` : ''}
                            </div>
                        </div>
                    `;
                }
            }

            habitsHtml += '</div>';
            return habitsHtml;
        }

        function formatDateForDisplay(dateString) {
            try {
                const date = new Date(dateString);
                const options = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                };
                return date.toLocaleDateString(undefined, options);
            } catch (error) {
                return dateString;
            }
        }

        function getHabitsSync() {
            try {
                const habits = localStorage.getItem('habits');
                return habits ? JSON.parse(habits) : [];
            } catch (error) {
                return [];
            }
        }

        // Delete entry function
        async function deleteEntry(dateString) {
            if (!confirm(`Are you sure you want to delete the entry for ${formatDateForDisplay(dateString)}? This action cannot be undone.`)) {
                return;
            }

            try {
                // Remove from localStorage
                const journalEntries = JSON.parse(localStorage.getItem('journalEntries') || '{}');
                delete journalEntries[dateString];
                localStorage.setItem('journalEntries', JSON.stringify(journalEntries));

                // Sync to cloud if connected
                if (isAuthenticated && dbx) {
                    const allData = {
                        journalEntries: journalEntries,
                        habits: JSON.parse(localStorage.getItem('habits') || '[]'),
                        finesStatus: JSON.parse(localStorage.getItem('finesStatus') || '[]'),
                        dailyHabitTracking: JSON.parse(localStorage.getItem('dailyHabitTracking') || '{}'),
                        lastSync: new Date().toISOString()
                    };
                    await syncToCloud(allData);
                }

                // Refresh the entries display
                await showAllEntries();
                
                showCustomModal('Success', `Entry for ${formatDateForDisplay(dateString)} has been deleted successfully!`, 'success');
            } catch (error) {
                console.error('Error deleting entry:', error);
                showCustomModal('Error', 'Failed to delete entry. Please try again.', 'error');
            }
        }

        // Fines Functionality
        function loadFines() {
            calculateCommittedFines();
            calculatePossibleFines();
        }

        function calculateCommittedFines() {
            const habits = getHabitsSync();
            const committedFines = [];
            
            // Get saved fines from localStorage
            const savedFines = getSavedFines();
            
            habits.forEach(habit => {
                if (!habit.fineAmount || habit.fineAmount <= 0) return;
                
                const fines = checkHabitFines(habit);
                fines.forEach(fine => {
                    const fineId = `${habit.id}_${fine.period}_${fine.periodStart}`;
                    const savedFine = savedFines.find(f => f.id === fineId);
                    
                    committedFines.push({
                        id: fineId,
                        habitId: habit.id,
                        habitName: habit.name,
                        habitColor: habit.color,
                        amount: habit.fineAmount,
                        period: fine.period,
                        periodStart: fine.periodStart,
                        periodEnd: fine.periodEnd,
                        required: fine.required,
                        actual: fine.actual,
                        details: fine.details,
                        isPaid: savedFine ? savedFine.isPaid : false
                    });
                });
            });
            
            renderCommittedFines(committedFines);
        }

        function checkHabitFines(habit) {
            const fines = [];
            const today = new Date();
            
            // Check weekly tracking
            if (habit.trackingFrequency === 'weekly' && habit.trackingAmount > 0) {
                const weekFines = checkWeeklyFines(habit, today);
                fines.push(...weekFines);
            }
            
            // Check monthly tracking  
            if (habit.trackingFrequency === 'monthly' && habit.trackingAmount > 0) {
                const monthFines = checkMonthlyFines(habit, today);
                fines.push(...monthFines);
            }
            
            // Check yearly tracking
            if (habit.trackingFrequency === 'yearly' && habit.trackingAmount > 0) {
                const yearFines = checkYearlyFines(habit, today);
                fines.push(...yearFines);
            }
            
            return fines;
        }

        function checkWeeklyFines(habit, today) {
            const fines = [];
            const weeksToCheck = 4; // Check last 4 weeks
            
            for (let i = 1; i <= weeksToCheck; i++) {
                const weekStart = getWeekStart(new Date(today.getTime() - (i * 7 * 24 * 60 * 60 * 1000)));
                const weekEnd = new Date(weekStart.getTime() + (6 * 24 * 60 * 60 * 1000));
                
                // Don't check current week
                if (weekEnd >= today) continue;
                
                const count = countHabitInPeriod(habit.id, weekStart, weekEnd, habit.trackingValue);
                
                if (count < habit.trackingAmount) {
                    fines.push({
                        period: 'weekly',
                        periodStart: formatDate(weekStart),
                        periodEnd: formatDate(weekEnd),
                        required: habit.trackingAmount,
                        actual: count,
                        details: `Week of ${formatDateForDisplay(formatDate(weekStart))}: Required ${habit.trackingAmount} "${habit.trackingValue}", got ${count}`
                    });
                }
            }
            
            return fines;
        }

        function checkMonthlyFines(habit, today) {
            const fines = [];
            const monthsToCheck = 3; // Check last 3 months
            
            for (let i = 1; i <= monthsToCheck; i++) {
                const monthStart = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const monthEnd = new Date(today.getFullYear(), today.getMonth() - i + 1, 0);
                
                const count = countHabitInPeriod(habit.id, monthStart, monthEnd, habit.trackingValue);
                
                if (count < habit.trackingAmount) {
                    fines.push({
                        period: 'monthly',
                        periodStart: formatDate(monthStart),
                        periodEnd: formatDate(monthEnd),
                        required: habit.trackingAmount,
                        actual: count,
                        details: `${monthStart.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}: Required ${habit.trackingAmount} "${habit.trackingValue}", got ${count}`
                    });
                }
            }
            
            return fines;
        }

        function checkYearlyFines(habit, today) {
            const fines = [];
            const lastYear = today.getFullYear() - 1;
            
            const yearStart = new Date(lastYear, 0, 1);
            const yearEnd = new Date(lastYear, 11, 31);
            
            const count = countHabitInPeriod(habit.id, yearStart, yearEnd, habit.trackingValue);
            
            if (count < habit.trackingAmount) {
                fines.push({
                    period: 'yearly',
                    periodStart: formatDate(yearStart),
                    periodEnd: formatDate(yearEnd),
                    required: habit.trackingAmount,
                    actual: count,
                    details: `Year ${lastYear}: Required ${habit.trackingAmount} "${habit.trackingValue}", got ${count}`
                });
            }
            
            return fines;
        }

        function calculatePossibleFines() {
            const habits = getHabitsSync();
            const possibleFines = [];
            const today = new Date();
            
            habits.forEach(habit => {
                if (!habit.fineAmount || habit.fineAmount <= 0) return;
                
                const warnings = checkHabitWarnings(habit, today);
                warnings.forEach(warning => {
                    possibleFines.push({
                        habitId: habit.id,
                        habitName: habit.name,
                        habitColor: habit.color,
                        amount: habit.fineAmount,
                        urgency: warning.urgency,
                        message: warning.message,
                        period: warning.period
                    });
                });
            });
            
            renderPossibleFines(possibleFines);
        }

        function checkHabitWarnings(habit, today) {
            const warnings = [];
            
            // Weekly warnings
            if (habit.trackingFrequency === 'weekly' && habit.trackingAmount > 0) {
                const weekStart = getWeekStart(today);
                const weekEnd = new Date(weekStart.getTime() + (6 * 24 * 60 * 60 * 1000));
                const currentCount = countHabitInPeriod(habit.id, weekStart, today, habit.trackingValue);
                const remaining = habit.trackingAmount - currentCount;
                const daysLeft = Math.ceil((weekEnd - today) / (24 * 60 * 60 * 1000));
                
                if (remaining > 0) {
                    let urgency = 'low';
                    if (daysLeft <= 1) urgency = 'high';
                    else if (daysLeft <= 2) urgency = 'medium';
                    
                    warnings.push({
                        period: 'weekly',
                        urgency: urgency,
                        message: `You need ${remaining} more "${habit.trackingValue}" this week. ${daysLeft} day(s) left.`
                    });
                }
            }
            
            // Monthly warnings
            if (habit.trackingFrequency === 'monthly' && habit.trackingAmount > 0) {
                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                const currentCount = countHabitInPeriod(habit.id, monthStart, today, habit.trackingValue);
                const remaining = habit.trackingAmount - currentCount;
                const daysLeft = Math.ceil((monthEnd - today) / (24 * 60 * 60 * 1000));
                
                if (remaining > 0) {
                    let urgency = 'low';
                    if (daysLeft <= 3) urgency = 'high';
                    else if (daysLeft <= 7) urgency = 'medium';
                    
                    warnings.push({
                        period: 'monthly',
                        urgency: urgency,
                        message: `You need ${remaining} more "${habit.trackingValue}" this month. ${daysLeft} day(s) left.`
                    });
                }
            }
            
            return warnings;
        }

        function countHabitInPeriod(habitId, startDate, endDate, trackingValue) {
            let count = 0;
            const journalEntries = JSON.parse(localStorage.getItem('journalEntries') || '{}');
            
            for (const [date, entry] of Object.entries(journalEntries)) {
                const entryDate = new Date(date);
                if (entryDate >= startDate && entryDate <= endDate) {
                    if (entry.habitData && entry.habitData[habitId]) {
                        const habitEntry = entry.habitData[habitId];
                        if (habitEntry.selectedValue === trackingValue) {
                            count++;
                        }
                    }
                }
            }
            
            return count;
        }

        function renderCommittedFines(fines) {
            const container = document.getElementById('committed-fines-list');
            const noFinesMsg = document.getElementById('no-committed-fines');
            
            if (!container) return;
            
            if (fines.length === 0) {
                container.innerHTML = '';
                noFinesMsg.style.display = 'block';
                return;
            }
            
            noFinesMsg.style.display = 'none';
            container.innerHTML = '';
            
            fines.forEach(fine => {
                const fineCard = document.createElement('div');
                fineCard.className = `fine-card ${fine.isPaid ? 'paid' : ''}`;
                
                fineCard.innerHTML = `
                    <div class="fine-card-header">
                        <div class="fine-habit-name" style="color: ${fine.habitColor}">${fine.habitName}</div>
                        <div class="fine-amount">$${fine.amount}</div>
                    </div>
                    <div class="fine-details">${fine.details}</div>
                    <div class="fine-status-section">
                        <select class="fine-status-dropdown ${fine.isPaid ? 'paid' : ''}" 
                                onchange="updateFineStatus('${fine.id}', this.value)">
                            <option value="unpaid" ${!fine.isPaid ? 'selected' : ''}>Unpaid</option>
                            <option value="paid" ${fine.isPaid ? 'selected' : ''}>Paid</option>
                        </select>
                    </div>
                `;
                
                container.appendChild(fineCard);
            });
        }

        function renderPossibleFines(fines) {
            const container = document.getElementById('possible-fines-list');
            const noWarningsMsg = document.getElementById('no-possible-fines');
            
            if (!container) return;
            
            if (fines.length === 0) {
                container.innerHTML = '';
                noWarningsMsg.style.display = 'block';
                return;
            }
            
            noWarningsMsg.style.display = 'none';
            container.innerHTML = '';
            
            fines.forEach(fine => {
                const warningCard = document.createElement('div');
                warningCard.className = 'warning-card';
                
                warningCard.innerHTML = `
                    <div class="warning-card-header">
                        <div class="warning-habit-name" style="color: ${fine.habitColor}">${fine.habitName}</div>
                        <div class="warning-urgency ${fine.urgency}">${fine.urgency}</div>
                    </div>
                    <div class="warning-message">${fine.message}</div>
                `;
                
                container.appendChild(warningCard);
            });
        }

        function updateFineStatus(fineId, status) {
            const savedFines = getSavedFines();
            const existingFineIndex = savedFines.findIndex(f => f.id === fineId);
            
            const isPaid = status === 'paid';
            
            if (existingFineIndex >= 0) {
                savedFines[existingFineIndex].isPaid = isPaid;
            } else {
                savedFines.push({ id: fineId, isPaid: isPaid });
            }
            
            localStorage.setItem('finesStatus', JSON.stringify(savedFines));
            
            // Refresh the fines display
            loadFines();
        }

        function getSavedFines() {
            try {
                return JSON.parse(localStorage.getItem('finesStatus') || '[]');
            } catch (error) {
                return [];
            }
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day;
            return new Date(d.setDate(diff));
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        // Yearly Goal Functions
        function getContributingValues() {
            const contributingValues = [];
            const checkboxes = document.querySelectorAll('#contributing-values-container input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                contributingValues.push(checkbox.value);
            });
            return contributingValues;
        }

        function populateContributingValues() {
            const container = document.getElementById('contributing-values-container');
            if (!container) return;
            
            // Clear existing checkboxes (keep help text)
            const helpText = container.querySelector('.contributing-values-help');
            container.innerHTML = '';
            if (helpText) container.appendChild(helpText);
            
            // Add checkboxes for each tracking value
            trackingValues.forEach(value => {
                const checkboxContainer = document.createElement('div');
                checkboxContainer.className = 'contributing-value-checkbox';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `contributing-${value}`;
                checkbox.value = value;
                
                const label = document.createElement('label');
                label.htmlFor = `contributing-${value}`;
                label.textContent = value;
                
                checkboxContainer.appendChild(checkbox);
                checkboxContainer.appendChild(label);
                container.appendChild(checkboxContainer);
            });
        }

        function populateYearlyGoalData(habit) {
            // Populate yearly goal amount
            const yearlyGoalAmountField = document.getElementById('yearly-goal-amount');
            if (yearlyGoalAmountField && habit.yearlyGoal) {
                yearlyGoalAmountField.value = habit.yearlyGoal.amount || '';
            }
            
            // Populate contributing values
            if (habit.yearlyGoal && habit.yearlyGoal.contributingValues) {
                setTimeout(() => {
                    habit.yearlyGoal.contributingValues.forEach(value => {
                        const checkbox = document.getElementById(`contributing-${value}`);
                        if (checkbox) checkbox.checked = true;
                    });
                }, 100);
            }
        }

        // Yearly Analytics Functionality
        function loadYearlyAnalytics() {
            loadYearOverview();
            loadYearlyGoalsProgress();
            loadWeeklyStreaks();
        }

        function loadYearOverview() {
            const today = new Date();
            const currentYear = today.getFullYear();
            const yearStart = new Date(currentYear, 0, 1);
            const yearEnd = new Date(currentYear, 11, 31);
            
            // Calculate days left in year
            const daysLeft = Math.ceil((yearEnd - today) / (24 * 60 * 60 * 1000));
            document.getElementById('days-left-value').textContent = daysLeft;
            
            // Calculate year progress
            const totalDays = Math.ceil((yearEnd - yearStart) / (24 * 60 * 60 * 1000)) + 1;
            const daysPassed = totalDays - daysLeft;
            const progressPercentage = Math.round((daysPassed / totalDays) * 100);
            document.getElementById('year-progress-value').textContent = `${progressPercentage}%`;
        }

        function loadYearlyGoalsProgress() {
            const habits = getHabitsSync();
            const habitsWithGoals = habits.filter(habit => 
                habit.yearlyGoal && 
                habit.yearlyGoal.amount > 0 && 
                habit.yearlyGoal.contributingValues && 
                habit.yearlyGoal.contributingValues.length > 0
            );
            
            const container = document.getElementById('yearly-goals-list');
            const noGoalsMsg = document.getElementById('no-yearly-goals');
            
            if (!container) return;
            
            if (habitsWithGoals.length === 0) {
                container.innerHTML = '';
                noGoalsMsg.style.display = 'block';
                return;
            }
            
            noGoalsMsg.style.display = 'none';
            container.innerHTML = '';
            
            habitsWithGoals.forEach(habit => {
                const progress = calculateYearlyProgress(habit);
                const progressCard = createGoalProgressCard(habit, progress);
                container.appendChild(progressCard);
            });
        }

        function calculateYearlyProgress(habit) {
            const currentYear = new Date().getFullYear();
            const yearStart = new Date(currentYear, 0, 1);
            const yearEnd = new Date(currentYear, 11, 31);
            
            let totalCount = 0;
            
            // Count all contributing values for this year
            habit.yearlyGoal.contributingValues.forEach(value => {
                totalCount += countHabitInPeriod(habit.id, yearStart, yearEnd, value);
            });
            
            const targetAmount = habit.yearlyGoal.amount;
            const progressPercentage = targetAmount > 0 ? Math.min((totalCount / targetAmount) * 100, 100) : 0;
            
            return {
                current: totalCount,
                target: targetAmount,
                percentage: progressPercentage,
                remaining: Math.max(targetAmount - totalCount, 0)
            };
        }

        function createGoalProgressCard(habit, progress) {
            const card = document.createElement('div');
            card.className = 'goal-progress-card';
            card.style.borderLeftColor = habit.color;
            
            const progressWidth = Math.round(progress.percentage);
            
            card.innerHTML = `
                <div class="goal-header">
                    <div class="goal-habit-name" style="color: ${habit.color}">${habit.name}</div>
                    <div class="goal-progress-text">${Math.round(progress.percentage)}% complete</div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" style="width: ${progressWidth}%; background-color: ${habit.color}"></div>
                </div>
                <div class="goal-stats">
                    <span>Progress: ${progress.current} / ${progress.target}</span>
                    <span>Remaining: ${progress.remaining}</span>
                </div>
            `;
            
            return card;
        }

        function loadWeeklyStreaks() {
            const habits = getHabitsSync();
            const habitsWithWeeklyGoals = habits.filter(habit => 
                habit.trackingFrequency === 'weekly' && 
                habit.trackingAmount > 0
            );
            
            const container = document.getElementById('weekly-streaks-list');
            const noStreaksMsg = document.getElementById('no-weekly-streaks');
            
            if (!container) return;
            
            const streaks = [];
            
            habitsWithWeeklyGoals.forEach(habit => {
                const streakData = calculateWeeklyStreak(habit);
                if (streakData.currentStreak > 0) {
                    streaks.push({
                        habit: habit,
                        ...streakData
                    });
                }
            });
            
            if (streaks.length === 0) {
                container.innerHTML = '';
                noStreaksMsg.style.display = 'block';
                return;
            }
            
            noStreaksMsg.style.display = 'none';
            container.innerHTML = '';
            
            // Sort by streak length (longest first)
            streaks.sort((a, b) => b.currentStreak - a.currentStreak);
            
            streaks.forEach(streakData => {
                const streakCard = createStreakCard(streakData);
                container.appendChild(streakCard);
            });
        }

        function calculateWeeklyStreak(habit) {
            const today = new Date();
            let currentStreak = 0;
            let bestStreak = 0;
            let consecutiveWeeks = 0;
            
            // Check the last 20 weeks
            for (let i = 0; i < 20; i++) {
                const weekStart = getWeekStart(new Date(today.getTime() - (i * 7 * 24 * 60 * 60 * 1000)));
                const weekEnd = new Date(weekStart.getTime() + (6 * 24 * 60 * 60 * 1000));
                
                // Skip current week
                if (weekEnd >= today && i === 0) continue;
                
                const count = countHabitInPeriod(habit.id, weekStart, weekEnd, habit.trackingValue);
                const goalMet = count >= habit.trackingAmount;
                
                if (goalMet) {
                    consecutiveWeeks++;
                    if (i === 0 || (currentStreak === 0 && consecutiveWeeks > 0)) {
                        currentStreak = consecutiveWeeks;
                    }
                } else {
                    if (currentStreak === 0) {
                        currentStreak = consecutiveWeeks;
                    }
                    consecutiveWeeks = 0;
                }
                
                bestStreak = Math.max(bestStreak, consecutiveWeeks);
            }
            
            // If we're still in a streak at the end, that's our current streak
            if (consecutiveWeeks > 0 && currentStreak === 0) {
                currentStreak = consecutiveWeeks;
            }
            
            return {
                currentStreak: currentStreak,
                bestStreak: Math.max(bestStreak, currentStreak)
            };
        }

        function createStreakCard(streakData) {
            const card = document.createElement('div');
            card.className = 'streak-card';
            
            const habit = streakData.habit;
            const message = getStreakMessage(habit, streakData.currentStreak);
            
            card.innerHTML = `
                <div class="streak-header">
                    <div class="streak-habit-name" style="color: ${habit.color}">${habit.name}</div>
                    <div class="streak-count">${streakData.currentStreak} weeks</div>
                </div>
                <div class="streak-message">${message}</div>
            `;
            
            return card;
        }

        function getStreakMessage(habit, streakWeeks) {
            const messages = [
                `You've hit the ${habit.name} goals for ${streakWeeks} weeks straight! Keep it up!`,
                `Amazing! ${streakWeeks} consecutive weeks of meeting your ${habit.name} target.`,
                `Fantastic streak! You've been consistent with ${habit.name} for ${streakWeeks} weeks.`,
                `Great job! ${streakWeeks} weeks in a row of achieving your ${habit.name} goals.`
            ];
            
            return messages[Math.floor(Math.random() * messages.length)];
        }

        // FINES SYSTEM IMPLEMENTATION
        
        // Period calculation helpers
        function getWeekStart(date) {
            const dt = new Date(date);
            dt.setHours(0, 0, 0, 0);
            const diff = (dt.getDay() + 6) % 7; // Monday = 0
            dt.setDate(dt.getDate() - diff);
            return dt;
        }
        
        function getWeekKey(date) {
            const weekStart = getWeekStart(date);
            return weekStart.toISOString().split('T')[0];
        }
        
        function getMonthKey(date) {
            const dt = new Date(date);
            return `${dt.getFullYear()}-${String(dt.getMonth() + 1).padStart(2, '0')}`;
        }
        
        // Live counter calculations
        const weekCountsCache = new Map();
        const monthCountsCache = new Map();
        
        function computeWeekCounts(habitId, refDate = new Date()) {
            const weekKey = getWeekKey(refDate);
            const cacheKey = `${weekKey}_${habitId}`;
            
            if (weekCountsCache.has(cacheKey)) {
                return weekCountsCache.get(cacheKey);
            }
            
            const weekStart = getWeekStart(refDate);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            weekEnd.setHours(23, 59, 59, 999);
            
            const counts = {};
            const allData = getAllHabitTrackingData();
            
            for (const [dateStr, dayData] of Object.entries(allData || {})) {
                const entryDate = new Date(dateStr);
                if (entryDate >= weekStart && entryDate <= weekEnd && dayData[habitId]) {
                    const habitData = dayData[habitId];
                    const value = habitData.selectedValue;
                    // Only count if not marked as out of control miss
                    if (value && !habitData.outOfControlMiss) {
                        counts[value] = (counts[value] || 0) + 1;
                    }
                }
            }
            
            weekCountsCache.set(cacheKey, counts);
            return counts;
        }
        
        function computeMonthCounts(habitId, refDate = new Date()) {
            const monthKey = getMonthKey(refDate);
            const cacheKey = `${monthKey}_${habitId}`;
            
            if (monthCountsCache.has(cacheKey)) {
                return monthCountsCache.get(cacheKey);
            }
            
            const counts = {};
            const allData = getAllHabitTrackingData();
            
            for (const [dateStr, dayData] of Object.entries(allData || {})) {
                const entryDate = new Date(dateStr);
                if (getMonthKey(entryDate) === monthKey && dayData[habitId]) {
                    const habitData = dayData[habitId];
                    const value = habitData.selectedValue;
                    // Only count if not marked as out of control miss
                    if (value && !habitData.outOfControlMiss) {
                        counts[value] = (counts[value] || 0) + 1;
                    }
                }
            }
            
            monthCountsCache.set(cacheKey, counts);
            return counts;
        }
        
        // Clear caches when data changes
        function clearCountsCache() {
            weekCountsCache.clear();
            monthCountsCache.clear();
        }
        
        // Habit rules storage and management
        function getHabitRules(habitId) {
            try {
                // First check the new format from habits data
                const habitsData = getHabitsSync();
                console.log(`getHabitRules for ${habitId} - all habits:`, habitsData);
                const habit = habitsData.find(h => h.id === habitId);
                console.log(`getHabitRules for ${habitId} - found habit:`, habit);
                
                if (habit && habit.frequencies) {
                    console.log(`Found habit with frequencies:`, habit);
                    const rules = {
                        weeklyLimits: {},
                        monthlyMinimums: {},
                        fine: { 
                            perOver: habit.fineAmount || 0, 
                            perUnder: habit.fineAmount || 0, 
                            currency: '‚Çπ' 
                        }
                    };
                    
                    // Convert frequencies to rules format
                    habit.frequencies.forEach(freq => {
                        console.log(`Processing frequency:`, freq);
                        console.log(`Rules before processing:`, JSON.stringify(rules));
                        if (freq.frequency === 'weekly') {
                            // For negative tracking values (like "no"), these are limits (max allowed)
                            if (freq.trackingValue === 'no' || freq.trackingValue === 'fail' || freq.trackingValue === 'missed') {
                                if (!rules.weeklyLimits) {
                                    console.error(`weeklyLimits is undefined! Full rules:`, rules);
                                    rules.weeklyLimits = {};
                                }
                                rules.weeklyLimits[freq.trackingValue] = freq.number;
                                console.log(`Added weekly limit: ${freq.trackingValue} = ${freq.number}`);
                            } else {
                                // For positive tracking values, these are minimums (required)
                                if (!rules.weeklyMinimums) {
                                    console.error(`weeklyMinimums is undefined! Full rules:`, rules);
                                    rules.weeklyMinimums = {};
                                }
                                rules.weeklyMinimums[freq.trackingValue] = freq.number;
                                console.log(`Added weekly minimum: ${freq.trackingValue} = ${freq.number}`);
                            }
                        } else if (freq.frequency === 'monthly') {
                            if (!rules.monthlyMinimums) {
                                console.error(`monthlyMinimums is undefined! Full rules:`, rules);
                                rules.monthlyMinimums = {};
                            }
                            rules.monthlyMinimums[freq.trackingValue] = freq.number;
                            console.log(`Added monthly minimum: ${freq.trackingValue} = ${freq.number}`);
                        }
                        console.log(`Rules after processing:`, JSON.stringify(rules));
                    });
                    
                    console.log(`Converted rules for habit ${habitId}:`, rules);
                    return rules;
                }
                
                console.log(`No habit found with frequencies for ${habitId}, using fallback`);
                // Fall back to old format
                const rules = JSON.parse(localStorage.getItem('habitRules') || '{}');
                return rules[habitId] || {
                    weeklyLimits: {},
                    monthlyMinimums: {},
                    fine: { perOver: 0, perUnder: 0, currency: '‚Çπ' }
                };
            } catch (error) {
                console.error('Error loading habit rules:', error);
                return { weeklyLimits: {}, monthlyMinimums: {}, fine: { perOver: 0, perUnder: 0, currency: '‚Çπ' } };
            }
        }
        
        function saveHabitRules(habitId, rules) {
            try {
                const allRules = JSON.parse(localStorage.getItem('habitRules') || '{}');
                allRules[habitId] = rules;
                localStorage.setItem('habitRules', JSON.stringify(allRules));
                
                // Trigger sync for habit rules
                triggerLiveSync('Habit rules updated');
            } catch (error) {
                console.error('Error saving habit rules:', error);
            }
        }
        
        // Fine storage and management
        function getFines() {
            try {
                return JSON.parse(localStorage.getItem('fines') || '[]');
            } catch (error) {
                console.error('Error loading fines:', error);
                return [];
            }
        }
        
        function saveFines(fines) {
            try {
                localStorage.setItem('fines', JSON.stringify(fines));
                triggerLiveSync('Fines updated');
            } catch (error) {
                console.error('Error saving fines:', error);
            }
        }
        
        // Live warnings calculation
        function calculateWarnings(habitId) {
            const rules = getHabitRules(habitId);
            const weekCounts = computeWeekCounts(habitId);
            const monthCounts = computeMonthCounts(habitId);
            console.log(`calculateWarnings for habit ${habitId}:`, {rules, weekCounts, monthCounts});
            const warnings = [];
            
            // Weekly limit warnings (positive messaging)
            for (const [valueKey, maxCount] of Object.entries(rules.weeklyLimits)) {
                const currentCount = weekCounts[valueKey] || 0;
                const remaining = maxCount - currentCount;
                
                if (remaining > 0) {
                    warnings.push({
                        type: 'weekly',
                        urgency: remaining <= 1 ? 'high' : remaining <= 2 ? 'medium' : 'low',
                        message: `‚úÖ Great! You can still avoid ${remaining} more "${valueKey}" this week`
                    });
                } else if (remaining === 0) {
                    warnings.push({
                        type: 'weekly',
                        urgency: 'high',
                        message: `‚ö†Ô∏è "${valueKey}" limit reached - be careful this week!`
                    });
                } else {
                    warnings.push({
                        type: 'weekly',
                        urgency: 'critical',
                        message: `‚ùå You've exceeded your "${valueKey}" limit this week - ‚Çπ500 fine applies`
                    });
                }
            }
            
            // Weekly minimum warnings (for positive tracking values like "yes", "go", etc.)
            if (rules.weeklyMinimums) {
                for (const [valueKey, minCount] of Object.entries(rules.weeklyMinimums)) {
                    const currentCount = weekCounts[valueKey] || 0;
                    const remaining = minCount - currentCount;
                    
                    if (remaining > 0) {
                        const today = new Date();
                        const currentWeekDay = today.getDay();
                        const daysUntilSunday = currentWeekDay === 0 ? 0 : 7 - currentWeekDay;
                        const urgency = daysUntilSunday <= 1 ? 'high' : daysUntilSunday <= 2 ? 'medium' : 'low';
                        
                        warnings.push({
                            type: 'weekly',
                            urgency: urgency,
                            message: `you need ${remaining} more "${valueKey}" to avoid weekly fine (‚Çπ500 penalty)`
                        });
                    }
                }
            }
            
            // Monthly minimum warnings
            for (const [valueKey, minCount] of Object.entries(rules.monthlyMinimums)) {
                const currentCount = monthCounts[valueKey] || 0;
                const remaining = minCount - currentCount;
                
                if (remaining > 0) {
                    const today = new Date();
                    const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
                    const daysLeft = daysInMonth - today.getDate();
                    const urgency = daysLeft <= 3 ? 'high' : daysLeft <= 7 ? 'medium' : 'low';
                    
                    warnings.push({
                        type: 'monthly',
                        urgency: urgency,
                        message: `you have already hit ${currentCount} "${valueKey}". please avoid it coz u only have ${remaining} more left for the month.`
                    });
                }
            }
            
            return warnings;
        }
        
        // Generate and get all fines based on habit violations
        function getFines() {
            const habits = getHabitsSync();
            const generatedFines = [];
            const today = new Date();
            
            habits.forEach(habit => {
                if (!habit.fineAmount || habit.fineAmount <= 0) return;
                
                // Check weekly violations for limits (like "no" violations)
                if (habit.frequencies) {
                    habit.frequencies.forEach(freq => {
                        if (freq.frequency === 'weekly') {
                            const weekCounts = computeWeekCounts(habit.id);
                            const currentCount = weekCounts[freq.trackingValue] || 0;
                            
                            // Check if this is a limit (negative values like "no")
                            if (freq.trackingValue === 'no' || freq.trackingValue === 'fail' || freq.trackingValue === 'missed') {
                                if (currentCount > freq.number) {
                                    const weekStart = getWeekStart(today);
                                    const fineId = `${habit.id}_weekly_limit_${formatDate(weekStart)}`;
                                    
                                    generatedFines.push({
                                        id: fineId,
                                        habitId: habit.id,
                                        habitName: habit.name,
                                        amount: `‚Çπ${habit.fineAmount}`,
                                        ruleType: 'weeklyLimit',
                                        periodKey: `Week of ${formatDate(weekStart)}`,
                                        status: 'committed',
                                        violation: `${currentCount}/${freq.number} ${freq.trackingValue}`
                                    });
                                }
                            } 
                            // Check if this is a minimum requirement (positive values like "go", "yes")
                            else {
                                if (currentCount < freq.number) {
                                    const weekStart = getWeekStart(today);
                                    const weekEnd = new Date(weekStart);
                                    weekEnd.setDate(weekEnd.getDate() + 6);
                                    
                                    // Only register fine if week is completed (past Sunday)
                                    if (today.getDay() === 0 || today > weekEnd) {
                                        const fineId = `${habit.id}_weekly_minimum_${formatDate(weekStart)}`;
                                        
                                        generatedFines.push({
                                            id: fineId,
                                            habitId: habit.id,
                                            habitName: habit.name,
                                            amount: `‚Çπ${habit.fineAmount}`,
                                            ruleType: 'weeklyMinimum',
                                            periodKey: `Week of ${formatDate(weekStart)}`,
                                            status: 'committed',
                                            violation: `${currentCount}/${freq.number} ${freq.trackingValue}`
                                        });
                                    }
                                }
                            }
                        }
                    });
                }
            });
            
            // Merge with saved fines from localStorage
            const savedFines = JSON.parse(localStorage.getItem('fines') || '[]');
            const allFines = [...savedFines];
            
            // Add new generated fines if they don't already exist
            generatedFines.forEach(newFine => {
                if (!allFines.find(f => f.id === newFine.id)) {
                    allFines.push(newFine);
                }
            });
            
            // Save updated fines
            localStorage.setItem('fines', JSON.stringify(allFines));
            
            return allFines;
        }

        // Helper function to get week start (Monday)
        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
            d.setDate(diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        function loadFines() {
            console.log('Loading fines...');
            displayCommittedFines();
            displayPossibleWarnings();
        }
        
        function displayCommittedFines() {
            const committedContainer = document.getElementById('committed-fines-list');
            const noCommittedMsg = document.getElementById('no-committed-fines');
            
            if (!committedContainer) return;
            
            const fines = getFines().filter(fine => fine.status === 'committed' || fine.status === 'pending');
            
            if (fines.length === 0) {
                committedContainer.innerHTML = '';
                if (noCommittedMsg) noCommittedMsg.style.display = 'block';
                return;
            }
            
            if (noCommittedMsg) noCommittedMsg.style.display = 'none';
            
            const finesHtml = fines.map(fine => {
                const habit = getHabitsSync().find(h => h.id === fine.habitId);
                const habitName = habit ? habit.name : 'Unknown Habit';
                
                return `
                    <div class="fine-item">
                        <div class="fine-header">
                            <span class="fine-habit">${habitName}</span>
                            <span class="fine-amount">${fine.amount}</span>
                        </div>
                        <div class="fine-details">
                            <span class="fine-reason">${fine.ruleType === 'weeklyLimit' ? 'Weekly limit exceeded' : 'Monthly minimum missed'}</span>
                            <span class="fine-period">${fine.periodKey}</span>
                        </div>
                        <div class="fine-status">
                            <select onchange="updateFineStatus('${fine.id}', this.value)">
                                <option value="pending" ${fine.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="committed" ${fine.status === 'committed' ? 'selected' : ''}>Committed</option>
                                <option value="paid" ${fine.status === 'paid' ? 'selected' : ''}>Paid</option>
                            </select>
                        </div>
                    </div>
                `;
            }).join('');
            
            committedContainer.innerHTML = finesHtml;
        }

        // Update fine status function
        function updateFineStatus(fineId, newStatus) {
            const fines = JSON.parse(localStorage.getItem('fines') || '[]');
            const fineIndex = fines.findIndex(f => f.id === fineId);
            
            if (fineIndex !== -1) {
                fines[fineIndex].status = newStatus;
                localStorage.setItem('fines', JSON.stringify(fines));
                
                // Trigger sync if available
                if (isAuthenticated && dbx) {
                    triggerLiveSync('Fine status updated');
                }
                
                // Refresh the fines display
                loadFines();
            }
        }
        
        function displayPossibleWarnings() {
            const possibleContainer = document.getElementById('possible-fines-list');
            const noPossibleMsg = document.getElementById('no-possible-fines');
            
            if (!possibleContainer) return;
            
            const habits = getHabitsSync();
            console.log('displayPossibleWarnings - habits:', habits);
            if (!Array.isArray(habits)) {
                console.error('getHabitsSync() did not return an array:', habits);
                return;
            }
            
            const allWarnings = [];
            
            habits.forEach(habit => {
                const warnings = calculateWarnings(habit.id);
                warnings.forEach(warning => {
                    allWarnings.push({
                        habitName: habit.name,
                        habitColor: habit.color,
                        ...warning
                    });
                });
            });
            
            if (allWarnings.length === 0) {
                possibleContainer.innerHTML = '';
                if (noPossibleMsg) noPossibleMsg.style.display = 'block';
                return;
            }
            
            if (noPossibleMsg) noPossibleMsg.style.display = 'none';
            
            const warningsHtml = allWarnings.map(warning => {
                const urgencyClass = `warning-${warning.urgency}`;
                const urgencyIcon = warning.urgency === 'critical' ? 'üö®' : 
                                  warning.urgency === 'high' ? '‚ö†Ô∏è' : 
                                  warning.urgency === 'medium' ? '‚ö°' : '‚ÑπÔ∏è';
                
                return `
                    <div class="warning-item ${urgencyClass}">
                        <div class="warning-header">
                            <span class="warning-icon">${urgencyIcon}</span>
                            <span class="warning-habit" style="color: ${warning.habitColor}">${warning.habitName}</span>
                        </div>
                        <div class="warning-message">${warning.message}</div>
                    </div>
                `;
            }).join('');
            
            possibleContainer.innerHTML = warningsHtml;
        }
        
        function updateFineStatus(fineId, newStatus) {
            const fines = getFines();
            const fine = fines.find(f => f.id === fineId);
            if (fine) {
                fine.status = newStatus;
                saveFines(fines);
                displayCommittedFines(); // Refresh display
            }
        }

        function loadYearlyAnalytics() {
            console.log('Loading yearly analytics...');
            
            // Load year overview
            const today = new Date();
            const currentYear = today.getFullYear();
            const yearEnd = new Date(currentYear, 11, 31);
            const daysLeft = Math.ceil((yearEnd - today) / (24 * 60 * 60 * 1000));
            
            const daysLeftElement = document.getElementById('days-left-value');
            const yearProgressElement = document.getElementById('year-progress-value');
            
            if (daysLeftElement) {
                daysLeftElement.textContent = daysLeft;
            }
            
            if (yearProgressElement) {
                const daysPassed = 365 - daysLeft;
                const progressPercentage = Math.round((daysPassed / 365) * 100);
                yearProgressElement.textContent = `${progressPercentage}%`;
            }
            
            // Load yearly goals progress
            const habits = getHabitsSync();
            const goalsContainer = document.getElementById('yearly-goals-list');
            const noGoalsMsg = document.getElementById('no-yearly-goals');
            const habitsWithGoals = habits.filter(habit => habit.yearlyGoal);
            
            if (goalsContainer && noGoalsMsg) {
                if (habitsWithGoals.length === 0) {
                    goalsContainer.style.display = 'none';
                    noGoalsMsg.style.display = 'block';
                } else {
                    noGoalsMsg.style.display = 'none';
                    goalsContainer.style.display = 'block';
                    goalsContainer.innerHTML = '';
                    
                    habitsWithGoals.forEach(habit => {
                        const goal = habit.yearlyGoal;
                        const progress = getYearlyGoalProgress(habit, goal);
                        const remaining = Math.max(0, goal.amount - progress.achieved);
                        
                        // Calculate daily pace needed to meet goal
                        const yearEnd = new Date(currentYear, 11, 31);
                        const daysRemaining = Math.ceil((yearEnd - today) / (24 * 60 * 60 * 1000));
                        const dailyPaceNeeded = daysRemaining > 0 ? (remaining / daysRemaining).toFixed(2) : 0;
                        
                        const goalItem = document.createElement('div');
                        goalItem.className = 'goal-item';
                        goalItem.style.backgroundColor = habit.color + '20'; // Add transparency to habit color
                        goalItem.style.border = `2px solid ${habit.color}`;
                        goalItem.innerHTML = `
                            <div class="goal-header">
                                <h4 style="color: ${habit.color}">${habit.name}</h4>
                                <div class="goal-progress">
                                    <span class="progress-text">${progress.achieved}/${goal.amount}</span>
                                    <span class="progress-percentage">${Math.round(progress.percentage)}%</span>
                                </div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${Math.min(progress.percentage, 100)}%; background-color: ${habit.color}"></div>
                            </div>
                            <div class="goal-details">
                                <p><strong>Target:</strong> ${goal.amount} in ${new Date().getFullYear()}</p>
                                <p><strong>Goals Left:</strong> ${remaining} remaining</p>
                            </div>
                        `;
                        
                        goalsContainer.appendChild(goalItem);
                    });
                }
            }
            
            // Load weekly streaks with proper formula calculation
            const streaksContainer = document.getElementById('weekly-streaks-list');
            const noStreaksMsg = document.getElementById('no-weekly-streaks');
            
            if (streaksContainer && noStreaksMsg) {
                const weeklyStreakData = calculateWeeklyStreaks(habits);
                
                if (weeklyStreakData.length === 0) {
                    streaksContainer.style.display = 'none';
                    noStreaksMsg.style.display = 'block';
                } else {
                    noStreaksMsg.style.display = 'none';
                    streaksContainer.style.display = 'block';
                    streaksContainer.innerHTML = '';
                    
                    weeklyStreakData.forEach(streak => {
                        const streakItem = document.createElement('div');
                        streakItem.className = 'streak-item';
                        streakItem.innerHTML = `
                            <div class="streak-header">
                                <h4 style="color: ${streak.color}">${streak.name}</h4>
                                <div class="streak-count">
                                    <span class="streak-number">${streak.currentStreak}</span>
                                    <span class="streak-label">weeks</span>
                                </div>
                            </div>
                            <div class="streak-details">
                                <p><strong>Current streak:</strong> ${streak.currentStreak} consecutive weeks</p>
                                <p><strong>Best streak:</strong> ${streak.bestStreak} weeks</p>
                                <p><strong>Success rate:</strong> ${streak.successRate}%</p>
                            </div>
                        `;
                        
                        streaksContainer.appendChild(streakItem);
                    });
                }
            }
        }

        // Get yearly goal progress for a habit
        function getYearlyGoalProgress(habit, goal) {
            if (!habit || !goal) return { achieved: 0, percentage: 0 };
            
            const currentYear = new Date().getFullYear();
            const dailyTracking = JSON.parse(localStorage.getItem('dailyHabitTracking') || '{}');
            
            let achieved = 0;
            
            // Count all instances where contributingValues were checked this year
            Object.entries(dailyTracking).forEach(([date, dayData]) => {
                const entryYear = new Date(date).getFullYear();
                if (entryYear === currentYear && dayData[habit.id]) {
                    const habitData = dayData[habit.id];
                    // Count each contributing value that was checked
                    goal.contributingValues.forEach(value => {
                        if (habitData[value] === true) {  // Explicitly check for true (checkbox marked)
                            achieved++;
                        }
                    });
                }
            });
            
            const percentage = goal.amount > 0 ? (achieved / goal.amount) * 100 : 0;
            
            return {
                achieved: achieved,
                percentage: percentage
            };
        }

        // Calculate weekly streaks for habits
        function calculateWeeklyStreaks(habits) {
            const streakData = [];
            const dailyTracking = JSON.parse(localStorage.getItem('dailyHabitTracking') || '{}');
            
            habits.forEach(habit => {
                if (habit.frequency !== 'weekly') return;
                
                // Get weekly data for this habit (last 12 weeks)
                const weeklyData = [];
                const today = new Date();
                
                for (let i = 0; i < 12; i++) {
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - (today.getDay() + 7 * i));
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);
                    
                    const weekKey = formatDate(weekStart);
                    const weekCount = computeWeekCounts(habit.id)[weekKey] || 0;
                    const isSuccessful = weekCount >= habit.trackingAmount;
                    
                    weeklyData.unshift({ weekStart, weekEnd, count: weekCount, successful: isSuccessful });
                }
                
                // Calculate current streak (from most recent week backwards)
                let currentStreak = 0;
                for (let i = weeklyData.length - 1; i >= 0; i--) {
                    if (weeklyData[i].successful) {
                        currentStreak++;
                    } else {
                        break;
                    }
                }
                
                // Calculate best streak
                let bestStreak = 0;
                let tempStreak = 0;
                weeklyData.forEach(week => {
                    if (week.successful) {
                        tempStreak++;
                        bestStreak = Math.max(bestStreak, tempStreak);
                    } else {
                        tempStreak = 0;
                    }
                });
                
                // Calculate success rate
                const successfulWeeks = weeklyData.filter(week => week.successful).length;
                const successRate = weeklyData.length > 0 ? Math.round((successfulWeeks / weeklyData.length) * 100) : 0;
                
                streakData.push({
                    id: habit.id,
                    name: habit.name,
                    color: habit.color,
                    currentStreak: currentStreak,
                    bestStreak: bestStreak,
                    successRate: successRate,
                    weeklyData: weeklyData
                });
            });
            
            return streakData;
        }
        
        // Function to update live counters and warnings for a specific habit
        function updateHabitCountersAndWarnings(habitId) {
            const habitCard = document.querySelector(`[onclick*="toggleOutOfControl('${habitId}')"]`).closest('.habit-tracking-card');
            if (!habitCard) return;
            
            clearCountsCache(); // Clear cache to get fresh data
            const weekCounts = computeWeekCounts(habitId);
            const warnings = calculateWarnings(habitId);
            
            // Update weekly counters
            const countersContainer = habitCard.querySelector('.weekly-counters');
            const countersHtml = Object.entries(weekCounts)
                .filter(([key, count]) => count > 0)
                .map(([key, count]) => `<span class="week-counter">${key}: ${count}</span>`)
                .join(' ');
                
            if (countersContainer) {
                countersContainer.innerHTML = countersHtml;
            } else if (countersHtml) {
                const habitName = habitCard.querySelector('.habit-tracking-name');
                const existingCounters = habitName.querySelector('.weekly-counters');
                if (existingCounters) {
                    existingCounters.innerHTML = countersHtml;
                } else {
                    habitName.innerHTML += `<div class="weekly-counters">${countersHtml}</div>`;
                }
            }
            
            // Update warnings
            let warningsContainer = habitCard.querySelector('.habit-warnings');
            const warningsHtml = warnings.length > 0 ? 
                warnings.map(w => `<span class="warning warning-${w.urgency}">${w.message}</span>`).join('') : '';
                
            if (warningsContainer) {
                if (warningsHtml) {
                    warningsContainer.innerHTML = warningsHtml;
                } else {
                    warningsContainer.remove();
                }
            } else if (warningsHtml) {
                const headerDiv = habitCard.querySelector('.habit-tracking-header');
                const newWarningsDiv = document.createElement('div');
                newWarningsDiv.className = 'habit-warnings';
                newWarningsDiv.innerHTML = warningsHtml;
                headerDiv.insertAdjacentElement('afterend', newWarningsDiv);
            }
        }
        
        // Function to update all live counters
        function updateLiveCounters() {
            const habits = getHabitsSync();
            habits.forEach(habit => {
                updateHabitCountersAndWarnings(habit.id);
            });
        }


    </script>
</body>
</html>
